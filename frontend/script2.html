<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web de Favores</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- React y ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- Babel (para JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Usar la fuente Inter como en el dise√±o original */
    body {
      font-family: "Inter", sans-serif;
    }

    /* Definiciones manuales para las animaciones de tailwindcss-animate */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes zoomIn95 {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes slideInFromLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInFromBottom4 {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation-duration: 150ms;
      animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .fade-in { animation-name: fadeIn; }
    .zoom-in-95 { animation-name: zoomIn95; }
    .slide-in-from-left { animation-name: slideInFromLeft; }
    .slide-in-from-bottom-4 { animation-name: slideInFromBottom4; }

    /* --- TUS ESTILOS PERSONALIZADOS (Adaptados) --- */
    
    .recorrido-view {
        font-family: "Arial", sans-serif;
        background-color: #fff;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        width: 100%;
    }

    .tracking-container {
        width: 100%;
        max-width: 800px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .recorrido-view h1 {
        font-size: 32px;
        font-weight: 900;
        margin-top: 20px;
        margin-bottom: 30px;
        text-align: center;
        color: #000;
    }

    .map-container {
        width: 100%;
        max-width: 500px;
        height: 250px;
        background-color: #eee;
        margin-bottom: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .info-section {
        display: flex;
        justify-content: center;
        gap: 40px;
        width: 100%;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }

    .card-custom {
        border: 1px solid #ccc;
        padding: 20px 30px;
        width: 100%;
        max-width: 300px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .card-custom h2 {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 25px;
        color: #000;
    }

    .card-custom p {
        font-size: 16px;
        font-weight: bold;
        margin: 15px 0;
        color: #000;
    }

    .btn-delivered {
        background-color: #2c2c2c;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .btn-delivered:hover {
        background-color: #000;
    }
    
    .btn-back-float {
        position: absolute;
        top: 20px;
        left: 20px;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Contenedor ra√≠z para la app React -->
  <div id="root"></div>

  <!-- Script de React (JSX) -->
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    const API_BASE_URL = "http://127.0.0.1:8000/api";

    const apiCall = async (endpoint, method = "GET", body = null) => {
      const token = localStorage.getItem("accessToken");
      const headers = {
        "Content-Type": "application/json",
        ...(token && { "Authorization": `Bearer ${token}` }) 
      };

      const config = {
        method,
        headers,
        ...(body && { body: JSON.stringify(body) })
      };

      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
        
        if (response.status === 401) {
           console.warn("Sesi√≥n expirada");
           localStorage.removeItem("accessToken");
        }
        
        if (response.status === 204) return true;
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || JSON.stringify(data));
        return data;
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    };

    // --- Iconos ---
    const IconProps = { className: "w-6 h-6 text-gray-700", strokeWidth: 2, fill: "none", stroke: "currentColor", strokeLinecap: "round", strokeLinejoin: "round" };
    const Menu = () => (<svg {...IconProps}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>);
    const ShoppingCart = () => (<svg {...IconProps}><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>);
    const User = () => (<svg {...IconProps}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
    const X = () => (<svg {...IconProps} className="w-5 h-5 text-gray-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
    const ArrowLeft = () => (<svg {...IconProps}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>);
    const ChevronUp = () => (<svg {...IconProps} className="w-5 h-5"><polyline points="18 15 12 9 6 15"></polyline></svg>);
    const ChevronDown = () => (<svg {...IconProps} className="w-5 h-5 text-gray-400"><polyline points="6 9 12 15 18 9"></polyline></svg>);
    const ChevronRight = () => (<svg {...IconProps} className="w-5 h-5 text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>);
    const Hand = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2z"></path></svg>);
    const UserPlus = ({ className }) => (<svg className={className} strokeWidth="1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>);
    const Plus = ({ className }) => (<svg {...IconProps} className={className || "w-5 h-5"}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
    const Trash = ({ className }) => (<svg {...IconProps} className={className || "w-6 h-6 text-gray-500 hover:text-red-600"}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
    const Walk = ({ className }) => (<svg className={className} strokeWidth="2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 19l-4-4l-1-7h10l-1 7l-4 4z"></path><circle cx="12" cy="5" r="2"></circle></svg>);
    const Check = ({ className }) => (<svg className={className} strokeWidth="3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>);
    const HelpCircle = () => (<svg {...IconProps} className="w-5 h-5 text-white"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
    const IdCard = ({ className }) => (<svg className={className} strokeWidth="1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"></rect><circle cx="8" cy="10" r="2"></circle><path d="M12 12c-2.5 0-5 1.5-5 3v2h10v-2c0-1.5-2.5-3-5-3z"></path><line x1="14" y1="8" x2="19" y2="8"></line><line x1="14" y1="11" x2="19" y2="11"></line></svg>);
    
    // Icono espec√≠fico para el repartidor en el historial
    const DeliveryIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" />
        <circle cx="12" cy="10" r="3" />
      </svg>
    );

    function DropdownMenu({ options, onSelect }) {
      return (
        <div className="absolute top-full left-0 mt-1 w-full bg-white rounded-lg shadow-2xl border border-gray-100 z-20 animate-in fade-in zoom-in-95">
          <div className="py-1 max-h-48 overflow-y-auto">
            {options.map((option) => (
              <button key={option} onClick={() => onSelect(option)} className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                {option}
              </button>
            ))}
          </div>
        </div>
      );
    }
    
    // --- COMPONENTE: Modal de Confirmaci√≥n ---
    function ConfirmacionModal({ onClose, servicio, desde, hasta, hora, onConfirmAction, costoBase }) {
      const base = costoBase !== undefined ? parseFloat(costoBase) : 1.50;
      const tarifaRepartidor = 2.25;
      const totalPagar = base + tarifaRepartidor;
      const [loading, setLoading] = useState(false);
      
      const handleFinalConfirm = async () => {
        if (!onConfirmAction) return;
        setLoading(true);
        try {
            await onConfirmAction(); 
            onClose(); 
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 animate-in fade-in">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto relative p-6 sm:p-8 space-y-4 animate-in zoom-in-95">
            <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full transition-colors"><X /></button>

            <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Confirmar tu Pedido</h2>
            
            <div className="text-sm text-gray-600 space-y-1 pt-2">
              <p><strong className="text-gray-900">Servicio:</strong> {servicio || "No especificado"}</p>
              <p><strong className="text-gray-900">Desde:</strong> {desde || "No especificado"}</p>
              <p><strong className="text-gray-900">Hasta:</strong> {hasta || "No especificado"}</p>
              <p><strong className="text-gray-900">Hora:</strong> {hora || "No especificado"}</p>
            </div>

            <div className="space-y-2 py-4 border-t">
              <h3 className="text-lg font-semibold text-gray-800">Monto a Pagar</h3>
              <div className="flex justify-between text-gray-700">
                <p>TOTAL {servicio === "Comprar/Llevar" ? "(Productos)" : "(Servicio)"}</p>
                <p>${base.toFixed(2)}</p>
              </div>
              <div className="flex justify-between text-gray-700">
                <p>Tarifa del repartidor</p>
                <p>${tarifaRepartidor.toFixed(2)}</p>
              </div>
              
              <div className="border-t border-gray-200 pt-2 mt-2"></div>
              <div className="flex justify-between text-xl font-bold text-black">
                <p>Total a pagar</p>
                <p>${totalPagar.toFixed(2)}</p>
              </div>
            </div>

            <div className="space-y-3 pb-4">
              <h3 className="text-lg font-semibold text-gray-800">M√©todos de Pagos</h3>
              <div className="bg-gray-100 border border-gray-200 rounded-lg p-3 flex items-center space-x-3">
                <span className="text-2xl">üíµ</span>
                <span className="font-medium text-gray-800">Efectivo</span>
              </div>
              <p className="text-xs text-gray-500">Pagar al repartidor al recibir el pedido</p>
            </div>

            <button onClick={handleFinalConfirm} disabled={loading} className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors flex justify-center">
              {loading ? "Procesando..." : "Confirmar y Publicar Pedido"}
            </button>
          </div>
        </div>
      );
    }

    // --- NUEVO COMPONENTE: Popover de Historial de Pedidos ---
    function OrderHistoryPopup({ isOpen, onClose, onNavigateToFullHistory, currentUserId }) {
        const [orders, setOrders] = useState([]);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            if (isOpen && currentUserId) {
                const fetchOrders = async () => {
                    setLoading(true);
                    try {
                        const data = await apiCall("/pedido/listar/");
                        // Filtramos por usuario y ordenamos descendente (m√°s reciente primero)
                        // Mostramos solo los √∫ltimos 3 pedidos para el popup
                        const myOrders = data.filter(o => o.idCliente === currentUserId).reverse().slice(0, 3);
                        setOrders(myOrders);
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchOrders();
            }
        }, [isOpen, currentUserId]);

        if (!isOpen) return null;

        const getStatusStyle = (status) => {
            // Mapeo de estados del backend a los colores de la imagen
            switch (status) {
                case "Entregado": return "bg-green-500 text-white"; // Completado (Verde)
                case "Aceptado": return "bg-orange-500 text-white"; // En curso (Naranja)
                case "Publicado": return "bg-orange-500 text-white"; // En curso/Pendiente (Naranja)
                default: return "bg-red-500 text-white"; // Asumimos Cancelado u otro como Rojo
            }
        };

        const getStatusText = (status) => {
             switch (status) {
                case "Entregado": return "Completado";
                case "Aceptado": return "En curso";
                case "Publicado": return "En curso"; // O "Pendiente"
                default: return "Cancelado";
            }
        };

        return (
            <div className="absolute top-16 right-4 w-full max-w-sm bg-white shadow-2xl rounded-xl border border-gray-100 overflow-hidden z-50 animate-in fade-in zoom-in-95">
                <div className="flex items-center justify-between p-4 border-b border-gray-100">
                    <h3 className="font-bold text-xl text-black">Historial de pedidos</h3>
                    <button onClick={onClose}><X className="w-6 h-6 text-black hover:text-gray-600" /></button>
                </div>
                
                <div className="max-h-96 overflow-y-auto">
                    {loading ? (
                        <div className="p-6 text-center text-gray-500">Cargando...</div>
                    ) : orders.length === 0 ? (
                        <div className="p-6 text-center text-gray-500">No tienes pedidos recientes.</div>
                    ) : (
                        <div className="divide-y divide-purple-100"> {/* Linea divisoria sutil como en la imagen */}
                            {orders.map(order => (
                                <div key={order.codigoPedido} className="p-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className="flex-shrink-0">
                                            {/* Icono de repartidor/paquete similar a la imagen */}
                                            <div className="border border-black rounded-lg p-1">
                                                <DeliveryIcon className="w-8 h-8 text-black" />
                                            </div>
                                        </div>
                                        <div className="min-w-0">
                                            <p className="text-sm font-medium text-black truncate max-w-[150px]">
                                                {order.descripcion}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {new Date(order.fechaInicial).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
                                            </p>
                                        </div>
                                    </div>
                                    <span className={`px-3 py-1 rounded-sm text-[10px] font-medium uppercase tracking-wide ${getStatusStyle(order.estado)}`}>
                                        {getStatusText(order.estado)}
                                    </span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                <div className="p-4 bg-white border-t border-gray-100 flex justify-center">
                    <button 
                        onClick={() => { onClose(); onNavigateToFullHistory(); }}
                        className="bg-red-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors text-sm"
                    >
                        Ver m√°s historial
                    </button>
                </div>
            </div>
        );
    }

    function MapComponent({ onLocationSelect, mapId }) {
      const mapRef = useRef(null); 
      const markerRef = useRef(null); 
      const onSelectRef = useRef(onLocationSelect);

      useEffect(() => {
        onSelectRef.current = onLocationSelect;
      }, [onLocationSelect]);

      useEffect(() => {
        if (mapRef.current) return;
        const containerId = mapId || "default-map"; 
        if (!document.getElementById(containerId)) return;

        const ESPOL_COORDS = [-2.1467, -79.9654]; 
        try {
            const map = L.map(containerId).setView(ESPOL_COORDS, 16); 
            mapRef.current = map;
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap", maxZoom: 19 }).addTo(map);
            map.on("click", function(e) {
                const { lat, lng } = e.latlng;
                if (markerRef.current) {
                    markerRef.current.setLatLng([lat, lng]);
                } else {
                    markerRef.current = L.marker([lat, lng]).addTo(map);
                }
                if (onSelectRef.current) {
                    onSelectRef.current(`Ubicaci√≥n: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
                }
            });
        } catch (err) { console.error("Error inicializando mapa:", err); }
        return () => { if (mapRef.current) { mapRef.current.off(); mapRef.current.remove(); mapRef.current = null; } };
      }, [mapId]);

      return <div id={mapId || "default-map"} className="w-full h-full z-0"></div>;
    }

    function SendReceiveView({ onGoBack, onNavigateToFastPrints, onNavigateToBuyTake }) {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [fecha, setFecha] = useState("");
      const [recogida, setRecogida] = useState("");
      const [entrega, setEntrega] = useState("");
      const [hora, setHora] = useState("");
      const [descripcion, setDescripcion] = useState("");
      const [whatsapp, setWhatsapp] = useState("");
      const [activeField, setActiveField] = useState("recogida");

      const isFormValid = fecha.trim() !== "" && recogida.trim() !== "" && entrega.trim() !== "" && hora.trim() !== "" && descripcion.trim() !== "" && whatsapp.trim() !== "";

      const handleMapSelection = (coordTexto) => {
          if (activeField === "recogida") setRecogida(coordTexto);
          else setEntrega(coordTexto);
      };

      const handleSubmit = async () => {
           try {
              if (!localStorage.getItem("accessToken")) { alert("Debes iniciar sesi√≥n."); return; }
              const nuevoPedido = await apiCall("/pedido/crear/", "POST", {
                  num_whats: whatsapp, 
                  descripcion: `${descripcion} (De: ${recogida} -> A: ${entrega})`,
                  punto_origen_id: 1, punto_desitno_id: 1,
                  horaDeseada: new Date().toISOString(),
                  fechaInicial: new Date().toISOString(),
                  costoEnvio: 3.75, estado: "Publicado"
              });
              alert("‚úÖ Pedido creado. La simulaci√≥n iniciar√° en breve...");
              onGoBack();
              setTimeout(async () => {
                  try {
                      await apiCall(`/pedido/simular-aceptacion/${nuevoPedido.codigoPedido}/`, "POST");
                      setTimeout(async () => {
                          await apiCall(`/pedido/simular-entrega/${nuevoPedido.codigoPedido}/`, "POST");
                          alert("üèÅ Tu pedido ha sido ENTREGADO por el repartidor.");
                      }, 15000); 
                  } catch (e) { console.error("Error en simulaci√≥n:", e); }
              }, 5000);
          } catch (error) { alert("Error: " + error.message); }
      };

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="w-full max-w-6xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
              <div className="flex gap-2">
                <button className="px-5 py-2 bg-black text-white rounded-full font-medium text-sm">Enviar/Recoger</button>
                <button onClick={onNavigateToFastPrints} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Impresiones r√°pidas</button>
                <button onClick={onNavigateToBuyTake} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Comprar/LLevar</button>
              </div>
              <div className="w-10 h-10"></div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-white rounded-2xl shadow-lg p-6 sm:p-8 space-y-4">
                <h2 className="text-3xl font-bold text-gray-800 mb-4">Informaci√≥n</h2>
                <input type="text" placeholder="Fecha" onFocus={(e) => (e.target.type = "date")} onBlur={(e) => (e.target.type = "text")} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={fecha} onChange={(e) => setFecha(e.target.value)} />
                <div className={`transition-all rounded-lg ${activeField === "recogida" ? "ring-2 ring-blue-500" : ""}`}>
                    <input type="text" placeholder="üìç Punto de Recogida (Toca aqu√≠)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={recogida} onChange={(e) => setRecogida(e.target.value)} onFocus={() => setActiveField("recogida")} />
                </div>
                <div className={`transition-all rounded-lg ${activeField === "entrega" ? "ring-2 ring-green-500" : ""}`}>
                    <input type="text" placeholder="üèÅ Punto de Entrega (Toca aqu√≠)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={entrega} onChange={(e) => setEntrega(e.target.value)} onFocus={() => setActiveField("entrega")} />
                </div>
                <input type="text" placeholder="Hora de Entrega Deseada" onFocus={(e) => (e.target.type = "time")} onBlur={(e) => (e.target.type = "text")} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={hora} onChange={(e) => setHora(e.target.value)} />
                <textarea placeholder="Descripci√≥n ¬øQu√© se transporta?" rows="4" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={descripcion} onChange={(e) => setDescripcion(e.target.value)}></textarea>
                <input type="tel" placeholder="Numero de Whatsapp" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={whatsapp} onChange={(e) => setWhatsapp(e.target.value)} />
                <button onClick={() => setIsModalOpen(true)} disabled={!isFormValid} className={isFormValid ? "w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors mt-2" : "w-full bg-gray-200 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed mt-2"}>Confirmar</button>
              </div>
              <div className={`bg-white rounded-2xl shadow-lg overflow-hidden relative min-h-[400px] border-4 transition-colors ${activeField === "recogida" ? "border-blue-100" : "border-green-100"}`}>
                 <MapComponent onLocationSelect={handleMapSelection} mapId="mapa-envios" />
                 <div className={`absolute bottom-4 right-4 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs font-bold z-[400] pointer-events-none border transition-colors ${activeField === "recogida" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-green-50 text-green-700 border-green-200"}`}>
                    {activeField === "recogida" ? "üìç Seleccionando: RECOGIDA" : "üèÅ Seleccionando: ENTREGA"}
                 </div>
              </div>
            </div>
          </div>
          {isModalOpen && <ConfirmacionModal onClose={() => setIsModalOpen(false)} servicio="Enviar/Recoger" desde={recogida} hasta={entrega} hora={hora} onConfirmAction={handleSubmit} costoBase={1.50} />}
        </div>
      );
    }

    function FastPrintsView({ onGoBack, onNavigateToSendReceive, onNavigateToBuyTake }) {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [fecha, setFecha] = useState("");
      const [recogida, setRecogida] = useState("");
      const [entrega, setEntrega] = useState("");
      const [hora, setHora] = useState("");
      const [activeField, setActiveField] = useState("recogida"); 
      const isInfoValid = fecha.trim() !== "" && recogida.trim() !== "" && entrega.trim() !== "" && hora.trim() !== "";
      
      const [pages, setPages] = useState("");
      const [copies, setCopies] = useState("1");
      const [color, setColor] = useState("Color");
      const [fileName, setFileName] = useState(null);
      const fileInputRef = useRef(null);
      const [openDropdown, setOpenDropdown] = useState(null);
      
      const handleUploadClick = () => fileInputRef.current.click();
      const handleFileSelect = (event) => { if(event.target.files[0]) setFileName(event.target.files[0].name); };
      const toggleDropdown = (name) => setOpenDropdown(openDropdown === name ? null : name);
      const handleSelect = (setter) => (val) => { setter(val); setOpenDropdown(null); };
      const handleMapSelection = (coordTexto) => { if (activeField === "recogida") setRecogida(coordTexto); else setEntrega(coordTexto); };

      const handleSubmitPrint = async () => {
          try {
              if (!localStorage.getItem("accessToken")) { alert("Debes iniciar sesi√≥n."); return; }
              const descripcion = `IMPRESI√ìN: ${fileName || "Sin archivo"} (${copies} copias, ${color}) \nRECOGER EN: ${recogida} \nENTREGAR EN: ${entrega}`;
              await apiCall("/pedido/crear/", "POST", {
                  num_whats: "0999999999", descripcion, punto_origen_id: 1, punto_desitno_id: 1,
                  horaDeseada: new Date().toISOString(), fechaInicial: new Date().toISOString(),
                  costoEnvio: 1.50, estado: "Publicado"
              });
              alert("‚úÖ Orden de impresi√≥n enviada."); onGoBack();
          } catch (error) { alert("Error: " + error.message); }
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="w-full max-w-6xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
              <div className="flex gap-2">
                <button onClick={onNavigateToSendReceive} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Enviar/Recoger</button>
                <button className="px-5 py-2 bg-black text-white rounded-full font-medium text-sm">Impresiones r√°pidas</button>
                <button onClick={onNavigateToBuyTake} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Comprar/LLevar</button>
              </div>
              <div className="w-10 h-10"></div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="flex flex-col gap-6">
                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <h2 className="text-3xl font-bold text-gray-800 mb-6">Informaci√≥n</h2>
                  <div className="space-y-4">
                    <input type="text" placeholder="Fecha" onFocus={(e)=>e.target.type="date"} onBlur={(e)=>e.target.type="text"} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={fecha} onChange={(e)=>setFecha(e.target.value)}/>
                    <div className={`transition-all rounded-lg ${activeField === "recogida" ? "ring-2 ring-blue-500" : ""}`}>
                        <input type="text" placeholder="üìç ¬øD√≥nde se imprime? (Recogida)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={recogida} onChange={(e)=>setRecogida(e.target.value)} onFocus={() => setActiveField("recogida")} />
                    </div>
                    <div className={`transition-all rounded-lg ${activeField === "entrega" ? "ring-2 ring-green-500" : ""}`}>
                        <input type="text" placeholder="üèÅ ¬øD√≥nde te lo llevan? (Entrega)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={entrega} onChange={(e)=>setEntrega(e.target.value)} onFocus={() => setActiveField("entrega")} />
                    </div>
                    <input type="text" placeholder="Hora de Entrega Deseada" onFocus={(e)=>e.target.type="time"} onBlur={(e)=>e.target.type="text"} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={hora} onChange={(e)=>setHora(e.target.value)}/>
                    <button onClick={() => setIsModalOpen(true)} disabled={!isInfoValid} className={`w-full py-3 rounded-lg font-medium text-white transition-colors ${isInfoValid ? "bg-black hover:bg-gray-800" : "bg-gray-200 text-gray-500 cursor-not-allowed"}`}>Confirmar</button>
                  </div>
                </div>
                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <h3 className="text-xl font-semibold text-gray-800 mb-4">Configuraci√≥n</h3>
                  <div className="space-y-4">
                    <input type="file" ref={fileInputRef} onChange={handleFileSelect} style={{ display: "none" }} accept=".pdf,.doc,.docx" />
                    <button onClick={handleUploadClick} className="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 border border-dashed border-gray-300">{fileName ? `üìÑ ${fileName}` : "Subir Archivo"}</button>
                    <div className="relative">
                        <button onClick={()=>toggleDropdown("color")} className="w-full flex justify-between items-center px-4 py-3 bg-gray-100 rounded-lg mt-1"><span>{color}</span><ChevronDown/></button>
                        {openDropdown === "color" && <DropdownMenu options={["Color", "Blanco y Negro"]} onSelect={handleSelect(setColor)}/>}
                    </div>
                    <input type="number" min="1" value={copies} onChange={(e)=>setCopies(e.target.value)} className="w-full px-4 py-3 bg-gray-100 rounded-lg mt-1" placeholder="Copias"/>
                  </div>
                </div>
              </div>
              <div className="flex flex-col gap-6 h-full">
                <div className={`bg-white rounded-2xl shadow-2xl overflow-hidden relative h-full min-h-[400px] border-4 transition-colors ${activeField === "recogida" ? "border-blue-100" : "border-green-100"}`}>
                   <MapComponent onLocationSelect={handleMapSelection} mapId="mapa-impresiones" />
                   <div className={`absolute bottom-4 right-4 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs font-bold z-[400] pointer-events-none border transition-colors ${activeField === "recogida" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-green-50 text-green-700 border-green-200"}`}>
                      {activeField === "recogida" ? "üìç Seleccionando: D√≥nde IMPRIMIR" : "üèÅ Seleccionando: D√≥nde ENTREGAR"}
                   </div>
                </div>
              </div>
            </div> 
          </div>
          {isModalOpen && <ConfirmacionModal onClose={() => setIsModalOpen(false)} servicio="Impresiones R√°pidas" desde={recogida} hasta={entrega} hora={hora} onConfirmAction={handleSubmitPrint} costoBase={1.50} />}
        </div>
      );
    }

    function BuyTakeView({ onGoBack, onNavigateToSendReceive, onNavigateToFastPrints }) {
      const [storeName, setStoreName] = useState("");
      const [storeAddress, setStoreAddress] = useState("");
      const [deliveryPoint, setDeliveryPoint] = useState("");
      const [whatsapp, setWhatsapp] = useState("");
      const [activeField, setActiveField] = useState("store"); 
      const [items, setItems] = useState([]); 
      const [nextId, setNextId] = useState(1);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const isInfoValid = storeName && storeAddress && deliveryPoint && whatsapp;
      const areItemsValid = items.length > 0 && items.every(i => i.description && i.quantity > 0);

      const totalEstimadoProductos = items.reduce((sum, item) => {
          const costo = parseFloat(item.cost) || 0;
          const cantidad = parseInt(item.quantity) || 1;
          return sum + (costo * cantidad);
      }, 0);

      const handleMapSelection = (coordTexto) => {
          if (activeField === "store") setStoreAddress(coordTexto);
          else setDeliveryPoint(coordTexto);
      };
      const handleAddItem = () => { setItems([...items, { id: nextId, description: "", quantity: 1, cost: "" }]); setNextId(nextId + 1); };
      const handleDeleteItem = (id) => setItems(items.filter(i => i.id !== id));
      const handleItemChange = (id, field, value) => { setItems(curr => curr.map(i => i.id === id ? { ...i, [field]: value } : i)); };
      
      const handleSubmitBuy = async () => {
          try {
              if (!localStorage.getItem("accessToken")) { alert("Inicia sesi√≥n primero."); return; }
              const listaTexto = items.map(i => `- ${i.quantity}x ${i.description} (Est: $${i.cost || "?"})`).join("\n");
              const descripcion = `COMPRAR: ${storeName} (${storeAddress}) -> Entregar: ${deliveryPoint}\nLISTA:\n${listaTexto}`;
              
              await apiCall("/pedido/crear/", "POST", {
                  num_whats: whatsapp, descripcion, punto_origen_id: 1, punto_desitno_id: 1,
                  horaDeseada: new Date().toISOString(), fechaInicial: new Date().toISOString(),
                  costoEnvio: (totalEstimadoProductos + 2.25).toFixed(2), 
                  estado: "Publicado"
              });
              alert("‚úÖ Pedido de compra creado."); onGoBack();
          } catch (e) { alert("Error: " + e.message); }
      };

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="w-full max-w-4xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full"><ArrowLeft /></button>
              <div className="flex gap-2">
                <button onClick={onNavigateToSendReceive} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300">Enviar/Recoger</button>
                <button onClick={onNavigateToFastPrints} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300">Impresiones r√°pidas</button>
                <button className="px-5 py-2 bg-black text-white rounded-full font-medium text-sm">Comprar/Llevar</button>
              </div>
              <div className="w-10 h-10"></div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
              <div className="bg-white rounded-2xl shadow-lg p-6 space-y-4 h-full">
                <h2 className="text-3xl font-bold text-gray-800 mb-4">Informaci√≥n</h2>
                <input type="text" placeholder="Nombre de la Tienda" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={storeName} onChange={e=>setStoreName(e.target.value)}/>
                <div className={`transition-all rounded-lg ${activeField === "store" ? "ring-2 ring-blue-500" : ""}`}>
                    <input type="text" placeholder="üìç Direcci√≥n Tienda (Toca para mapa)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={storeAddress} onChange={e=>setStoreAddress(e.target.value)} onFocus={() => setActiveField("store")} />
                </div>
                <div className={`transition-all rounded-lg ${activeField === "delivery" ? "ring-2 ring-green-500" : ""}`}>
                    <input type="text" placeholder="üèÅ Punto de Entrega (Toca para mapa)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={deliveryPoint} onChange={e=>setDeliveryPoint(e.target.value)} onFocus={() => setActiveField("delivery")} />
                </div>
                <input type="tel" placeholder="Tu Whatsapp" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={whatsapp} onChange={e=>setWhatsapp(e.target.value)}/>
              </div>

              <div className={`bg-white rounded-2xl shadow-lg overflow-hidden relative min-h-[400px] border-4 transition-colors ${activeField === "store" ? "border-blue-100" : "border-green-100"}`}>
                 <MapComponent onLocationSelect={handleMapSelection} mapId="mapa-compras" />
                 <div className={`absolute bottom-4 right-4 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs font-bold z-[400] pointer-events-none border transition-colors ${activeField === "store" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-green-50 text-green-700 border-green-200"}`}>
                    {activeField === "store" ? "üìç Seleccionando: TIENDA" : "üèÅ Seleccionando: ENTREGA"}
                 </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6 space-y-4">
              <h2 className="text-3xl font-bold text-gray-800 mb-4">Lista de Compras</h2>
              {items.map(item => (
                  <div key={item.id} className="flex gap-2 items-center">
                      <input className="w-full p-3 bg-gray-100 rounded" placeholder="Producto" value={item.description} onChange={e=>handleItemChange(item.id, "description", e.target.value)}/>
                      <input type="number" className="w-20 p-3 bg-gray-100 rounded text-center" placeholder="#" value={item.quantity} onChange={e=>handleItemChange(item.id, "quantity", e.target.value)}/>
                      <input type="number" className="w-24 p-3 bg-gray-100 rounded text-center" placeholder="$ Est." value={item.cost} onChange={e=>handleItemChange(item.id, "cost", e.target.value)}/>
                      <button onClick={()=>handleDeleteItem(item.id)} className="p-2 text-red-500"><Trash/></button>
                  </div>
              ))}
              <button onClick={handleAddItem} className="flex items-center gap-2 px-4 py-2 border-2 border-dashed rounded text-gray-600 hover:bg-gray-50"><Plus className="w-4 h-4"/> A√±adir Producto</button>
              
              <div className="text-right text-lg font-bold mt-2">
                  Total Estimado: ${totalEstimadoProductos.toFixed(2)}
              </div>
            </div>

            <div className="mt-8 flex justify-end">
              <button onClick={() => setIsModalOpen(true)} disabled={!isInfoValid || !areItemsValid} className={`px-8 py-3 rounded-lg font-medium text-white ${isInfoValid && areItemsValid ? "bg-black hover:bg-gray-800" : "bg-gray-300 cursor-not-allowed"}`}>Confirmar y Pagar</button>
            </div>
          </div>
          
          {isModalOpen && <ConfirmacionModal 
            onClose={() => setIsModalOpen(false)} 
            servicio="Comprar/Llevar" 
            desde={storeName} 
            hasta={deliveryPoint} 
            hora="N/A" 
            costoBase={totalEstimadoProductos} 
            onConfirmAction={handleSubmitBuy}
          />}
        </div>
      );
    }

    function NewFavorView({ onGoBack, onNavigateToSendReceive, onNavigateToFastPrints, onNavigateToBuyTake }) {
      return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl mx-auto">
            <div className="flex items-center p-6 pb-4">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors mr-4"><ArrowLeft /></button>
              <h2 className="text-4xl font-bold text-gray-800">Programa tu Mandado</h2>
            </div>
            <div className="px-6 pb-6">
              <div className="mt-4">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Categor√≠a de Servicios</h3>
                <div className="flex flex-col gap-4">
                  <div onClick={onNavigateToFastPrints} className="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <div className="flex justify-between items-center"><h4 className="font-bold text-sm">IMPRESIONES R√ÅPIDAS</h4><ChevronUp /></div>
                    <p className="text-sm text-gray-600 mt-2">Sube archivos digitales y recoge el pedido listo en el punto designado.</p>
                  </div>
                  <div onClick={onNavigateToSendReceive} className="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <h4 className="font-bold text-sm">ENVIAR/RECOGER</h4>
                    <p className="text-sm text-gray-600 mt-2">Servicio de mensajer√≠a interna r√°pido para trasladar objetos entre dos puntos del campus.</p>
                  </div>
                  <div onClick={onNavigateToBuyTake} className="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <h4 className="font-bold text-sm">COMPRAR/LLEVAR</h4>
                    <p className="text-sm text-gray-600 mt-2">Pide art√≠culos de tiendas fuera del campus y rec√≠belos sin salir.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function DriverRegisterView({ onGoBack, onNavigateToWelcome, onSignIn, onRegister }) {
      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex items-center justify-between h-16">
                <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
                <div className="flex items-center gap-3">
                  <button onClick={onSignIn} className="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Sign in</button>
                  <button onClick={onRegister} className="px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg transition-colors">Register</button>
                  <div className="w-px h-8 bg-gray-300 mx-2" />
                  <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative"><ShoppingCart /></button>
                </div>
              </div>
            </div>
          </header>
          <main className="max-w-7xl mx-auto py-0">
            <div className="bg-black text-white p-8 md:p-16 rounded-b-2xl shadow-xl overflow-hidden relative">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div className="relative z-10 space-y-4 max-w-lg">
                  <h1 className="text-4xl md:text-5xl font-bold leading-tight">Haz entregas en tu universidad.</h1>
                  <p className="text-gray-300 text-lg">Reg√≠strate en nuestra plataforma y empieza a hacer env√≠os en tu universidad.</p>
                  <button onClick={onNavigateToWelcome} className="px-6 py-3 bg-white text-black rounded-lg font-semibold hover:bg-gray-200 transition-colors shadow-lg mt-6">Reg√≠strate para hacer entregas</button>
                </div>
                <div className="hidden md:block absolute right-0 top-0 h-full w-1/2 p-8 pt-16 lg:p-16">
                   <div className="absolute inset-0">
                        <svg viewBox="0 0 100 100" className="w-full h-full" preserveAspectRatio="xMidYMid meet">
                            <rect x="62" y="10" width="18" height="3" fill="#B30000" rx="1.5"/><rect x="65" y="13" width="12" height="5" fill="#B30000" rx="1"/><circle cx="71" cy="22" r="5" fill="#F0C088" />
                            <path d="M68 30 L64 50 L68 50 L72 30 Z" fill="#FFFFFF" stroke="#000000" strokeWidth="1"/><path d="M74 30 L78 50 L74 50 L70 30 Z" fill="#FFFFFF" stroke="#000000" strokeWidth="1"/>
                            <path d="M65 55 L63 80 L67 80 L69 55 Z" fill="#6A6A6A"/><path d="M77 55 L75 80 L79 80 L81 55 Z" fill="#6A6A6A"/>
                            <rect x="58" y="38" width="26" height="20" fill="#E48E44" stroke="#000000" strokeWidth="1"/><line x1="58" y1="48" x2="84" y2="48" stroke="#000000" strokeWidth="1"/><line x1="71" y1="38" x2="71" y2="58" stroke="#000000" strokeWidth="1"/>
                        </svg>
                </div>
                </div>
              </div>
            </div>
            <div className="px-4 sm:px-6 lg:px-8 py-12 md:py-16">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                <div>
                  <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Walk className="w-6 h-6 text-black" />Descubre lo que necesitas para empezar a trabajar.</h3>
                  <ul className="text-gray-600 space-y-2"><li className="flex items-center gap-2"><Check className="w-4 h-4 text-green-500" /> C√©dula de identidad o carnet estudiantil.</li><li className="flex items-center gap-2"><Check className="w-4 h-4 text-green-500" /> Tiempo libre</li></ul>
                </div>
                <div className="md:col-span-1">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">En 3 simples pasos</h3>
                  <ol className="text-gray-600 space-y-2 list-none p-0"><li className="font-semibold text-black">1. Reg√≠strate</li><li>2. Recoge y entrega</li><li>3. Gana dinero</li></ol>
                </div>
              </div>
            </div>
          </main>
        </div>
      );
    }

    function DriverWelcomeView({ onGoBack, onNavigateToProfilePhoto, onNavigateToCarnetPhoto }) { 
      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <header className="max-w-4xl mx-auto mb-12"><div className="flex items-center justify-between h-16"><button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button></div></header>
          <main className="max-w-4xl mx-auto">
            <h1 className="text-5xl sm:text-6xl font-bold text-gray-900 mb-16">Te damos la bienvenida.</h1>
            <div className="space-y-4">
              <button onClick={onNavigateToProfilePhoto} className="w-full flex justify-between items-center p-6 border-b border-purple-200 hover:bg-purple-50 transition-colors group"><span className="text-lg font-medium text-gray-800">Foto de perfil.</span><ChevronRight /></button>
              <button onClick={onNavigateToCarnetPhoto} className="w-full flex justify-between items-center p-6 border-b border-purple-200 hover:bg-purple-50 transition-colors group"><span className="text-lg font-medium text-gray-800">Foto del carnet estudiantil.</span><ChevronRight /></button>
            </div>
          </main>
        </div>
      );
    }
    
    function CarnetPhotoUploadView({ onGoBack }) {
      const fileInputRef = useRef(null);
      const [fileName, setFileName] = useState(null);
      const handleUploadClick = () => fileInputRef.current.click();
      const handleFileSelect = (event) => { const file = event.target.files[0]; if (file) setFileName(file.name); };
      return (
        <div className="min-h-screen bg-pink-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <header className="max-w-xl mx-auto mb-8 flex justify-between items-center"><button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button><button className="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black transition-colors"><HelpCircle /><span className="text-sm font-medium">Ayuda</span></button></header>
          <main className="max-w-xl mx-auto">
            <h1 className="text-4xl sm:text-5xl font-bold text-gray-900 mb-6">Tomate una foto al carnet estudiantil.</h1>
            <p className="text-gray-700 mb-6">Toma una foto de tu carn√© estudiantil de la ESPOL.</p>
            <div className="w-full flex justify-center mb-8"><div className="w-full max-w-sm h-48 bg-gray-300 rounded-xl flex items-center justify-center border-4 border-dashed border-gray-400"><IdCard className="w-40 h-40 text-gray-500" /></div></div>
            <div className="space-y-4"><input type="file" ref={fileInputRef} onChange={handleFileSelect} style={{ display: "none" }} accept="image/*" /><button onClick={handleUploadClick} className="w-full bg-gray-800 text-white py-4 rounded-lg font-medium hover:bg-black transition-colors">{fileName ? `Cargar foto: ${fileName}` : "Cargar foto"}</button></div>
          </main>
        </div>
      );
    }

    function ProfilePhotoUploadView({ onGoBack }) {
      const [stream, setStream] = useState(null); 
      const [error, setError] = useState(null); 
      const videoRef = useRef(null); 
      const handleStartCamera = async () => { setError(null); try { const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false }); setStream(s); } catch (err) { console.error("Error accessing camera: ", err); setError("No se pudo acceder a la c√°mara."); } };
      useEffect(() => { if (stream && videoRef.current) { videoRef.current.srcObject = stream; } return () => { if (stream) { stream.getTracks().forEach(track => track.stop()); } }; }, [stream]); 
      return (
        <div className="min-h-screen bg-pink-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <header className="max-w-xl mx-auto mb-8 flex justify-between items-center"><button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button><button className="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black transition-colors"><HelpCircle /><span className="text-sm font-medium">Ayuda</span></button></header>
          <main className="max-w-xl mx-auto">
            <h1 className="text-4xl sm:text-5xl font-bold text-gray-900 mb-6">Tomate una foto de perfil.</h1>
            <div className="w-full flex justify-center mb-8"><div className="w-56 h-56 bg-gray-300 rounded-full flex items-center justify-center overflow-hidden">{stream ? (<video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover transform -scale-x-100" />) : (<User className="w-32 h-32 text-gray-500" />)}</div></div>
            {error && (<div className="text-center text-red-600 font-medium mb-4">{error}</div>)}
            <div className="space-y-4">{stream ? (<button className="w-full bg-gray-800 text-white py-4 rounded-lg font-medium hover:bg-black transition-colors">Capturar foto</button>) : (<button onClick={handleStartCamera} className="w-full bg-gray-800 text-white py-4 rounded-lg font-medium hover:bg-black transition-colors">Tomar foto</button>)}</div>
          </main>
        </div>
      );
    }
    
    function ActiveOrderView({ orderId, userRole, onGoBack }) {
        const [order, setOrder] = useState(null);
        useEffect(() => {
            const fetchDetail = async () => { try { const data = await apiCall(`/pedido/detalle/${orderId}/`); setOrder(data); } catch (e) { console.error(e); } };
            fetchDetail();
            const interval = setInterval(fetchDetail, 5000); 
            return () => clearInterval(interval);
        }, [orderId]);
        const handleComplete = async () => { if (!confirm("¬øConfirmas la entrega?")) return; try { await apiCall(`/pedido/actualizar/${orderId}/`, "PATCH", { estado: "Entregado" }); alert("¬°Pedido entregado!"); onGoBack(); } catch (e) { alert(e.message); } };
        if (!order) return <div className="p-10 text-center">Cargando informaci√≥n del pedido...</div>;
        const isDriver = userRole === "repartidor";
        return (
            <div className="recorrido-view relative">
                <div className="btn-back-float" onClick={onGoBack}><ArrowLeft /></div>
                <div className="tracking-container">
                    <h1>Recorrido del pedido: #{order.codigoPedido}</h1>
                    <div className="map-container"><MapComponent mapId="active-map" /></div>
                    <div className="info-section">
                        <div className="card-custom"><h2>Recogida</h2><p>Estado: <span className="text-blue-600">{order.estado}</span></p><br /> <p>Desde: {order.punto_origen_id} (FCI)</p> <p>Cliente: {order.cliente_nombre}</p></div>
                        <div className="card-custom"><h2>Entrega</h2><p>Hora deseada: {order.horaDeseada ? order.horaDeseada.split("T")[1]?.slice(0,5) : "--:--"}</p><br /> <p>Hasta: {order.punto_destino_id} (Rectorado)</p><p>Costo: ${order.costoEnvio}</p></div>
                    </div>
                    <div className="btn-container">{isDriver && order.estado !== "Entregado" ? (<button className="btn-delivered" onClick={handleComplete}>Confirmar Pedido Entregado</button>) : (<div className="text-center font-bold text-gray-500">{order.estado === "Entregado" ? "‚úÖ Pedido Finalizado" : "üöó Pedido en curso..."}</div>)}</div>
                </div>
            </div>
        );
    }

    function DriverFeedView({ onGoBack, onNavigateToActiveOrder }) {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => { fetchOrders(); }, []);
      const fetchOrders = async () => { try { const data = await apiCall("/pedido/listar/"); const disponibles = data.filter(o => o.estado === "Publicado"); setOrders(disponibles); } catch (error) { console.error(error); } finally { setLoading(false); } };
      const handleAccept = async (orderId) => { try { await apiCall(`/pedido/aceptar/${orderId}/`, "PATCH"); alert("¬°Pedido aceptado! Redirigiendo al mapa..."); onNavigateToActiveOrder(orderId); } catch (error) { alert("Error: " + error.message); fetchOrders(); } };
      return (
        <div className="min-h-screen bg-gray-50 p-4 animate-in fade-in">
          <header className="flex items-center mb-6"><button onClick={onGoBack} className="p-2 mr-4 bg-white rounded-full shadow"><ArrowLeft /></button><h1 className="text-2xl font-bold text-gray-800">Pedidos Disponibles</h1></header>
          {loading ? <p className="text-center py-10">Cargando...</p> : (
            <div className="space-y-4 max-w-2xl mx-auto">
                {orders.length === 0 && <p className="text-center text-gray-500">No hay pedidos disponibles.</p>}
                {orders.map(order => (
                    <div key={order.codigoPedido} className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex justify-between mb-2"><h3 className="font-bold text-lg">Pedido #{order.codigoPedido}</h3><span className="bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold">${order.costoEnvio}</span></div>
                        <p className="text-gray-600 mb-4">{order.descripcion}</p>
                        <button onClick={() => handleAccept(order.codigoPedido)} className="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800">Aceptar Pedido</button>
                    </div>
                ))}
            </div>
          )}
        </div>
      );
    }

    function MyOrdersView({ onGoBack, onNavigateToActiveOrder, currentUserId }) {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => { fetchMyOrders(); }, []);
      const fetchMyOrders = async () => { try { const data = await apiCall("/pedido/listar/"); const misPedidos = data.filter(o => o.idCliente === currentUserId); setOrders(misPedidos.reverse()); } catch (error) { console.error(error); } finally { setLoading(false); } };
      const getStatusColor = (estado) => { switch(estado) { case "Publicado": return "bg-gray-100 text-gray-600"; case "Aceptado": return "bg-blue-100 text-blue-700"; case "Entregado": return "bg-green-100 text-green-700"; default: return "bg-gray-100"; } };
      return (
        <div className="min-h-screen bg-gray-50 p-4 animate-in fade-in">
          <header className="flex items-center mb-6"><button onClick={onGoBack} className="p-2 mr-4 bg-white rounded-full shadow"><ArrowLeft /></button><h1 className="text-2xl font-bold text-gray-800">Mis Pedidos</h1></header>
          {loading ? <p className="text-center py-10">Cargando historial...</p> : (
            <div className="space-y-4 max-w-2xl mx-auto">
                {orders.length === 0 && (<div className="text-center py-10 text-gray-500 bg-white rounded-xl shadow-sm"><p className="mb-2">No has realizado pedidos a√∫n.</p></div>)}
                {orders.map(order => (
                    <div key={order.codigoPedido} onClick={() => { if (order.estado === "Aceptado" || order.estado === "Entregado") { onNavigateToActiveOrder(order.codigoPedido); } }} className={`bg-white p-5 rounded-xl shadow-sm border border-gray-100 transition-all ${order.estado === "Aceptado" ? "cursor-pointer hover:shadow-md ring-1 ring-blue-200" : ""}`}>
                        <div className="flex justify-between items-start mb-2"><div><span className={`text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wider ${getStatusColor(order.estado)}`}>{order.estado}</span><span className="text-gray-400 text-xs ml-2">#{order.codigoPedido}</span></div><span className="font-bold text-gray-900">${order.costoEnvio}</span></div>
                        <h3 className="font-semibold text-gray-800 mb-1">{order.descripcion}</h3>
                        <div className="text-sm text-gray-500 mt-3 flex justify-between items-end"><span>üìÖ {new Date(order.fechaInicial).toLocaleDateString()}</span>{order.estado === "Aceptado" && (<span className="text-blue-600 font-medium text-xs flex items-center gap-1">Ver mapa <ChevronRight /></span>)}</div>
                    </div>
                ))}
            </div>
          )}
        </div>
      );
    }

    function HomePage() {
      const [menuOpen, setMenuOpen] = useState(false);
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [authMode, setAuthMode] = useState("signin");
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [currentUser, setCurrentUser] = useState(null);
      const [showUserMenu, setShowUserMenu] = useState(false); 
      // Estado para controlar el carrito/historial
      const [isCartOpen, setIsCartOpen] = useState(false);

      const [activeOrderId, setActiveOrderId] = useState(null);
      const [ignoredOrderId, setIgnoredOrderId] = useState(null);
      const [currentView, setCurrentView] = useState("home"); 
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [nombre, setNombre] = useState("");
      const [apellido, setApellido] = useState("");

      useEffect(() => {
        const checkStatus = async () => {
            if (!currentUser || !isLoggedIn) return;
            if (currentView === "activeOrder") return;
            try {
                const data = await apiCall("/pedido/listar/");
                const pedidoAceptado = data.find(p => (p.estado === "Aceptado" || p.estado === "Entregado") && currentUser && p.idCliente === currentUser.id);
                if (pedidoAceptado && pedidoAceptado.codigoPedido !== ignoredOrderId) { console.log("¬°Pedido detectado!", pedidoAceptado); setActiveOrderId(pedidoAceptado.codigoPedido); setCurrentView("activeOrder"); }
            } catch (error) { if (error.message !== "Sesi√≥n expirada") console.error(error); }
        };
        const interval = setInterval(checkStatus, 3000);
        return () => clearInterval(interval);
      }, [currentView, currentUser, isLoggedIn, ignoredOrderId]); 

      useEffect(() => { const token = localStorage.getItem("accessToken"); if (token) { apiCall("/usuario/me/").then(u => { setIsLoggedIn(true); setCurrentUser(u); }).catch(() => { setIsLoggedIn(false); localStorage.removeItem("accessToken"); }); } }, []);
      const handleLogout = () => { localStorage.removeItem("accessToken"); setIsLoggedIn(false); setCurrentUser(null); setShowUserMenu(false); };
      const handleAuth = async () => {
          console.log("Intentando autenticaci√≥n..."); 
          try {
              if (authMode === "signin") {
                  console.log("Enviando Login...", { email, pass });
                  const data = await apiCall("/login/", "POST", { email: email, password: pass });
                  localStorage.setItem("accessToken", data.access);
                  const me = await apiCall("/usuario/me/");
                  setCurrentUser(me); setIsLoggedIn(true); setShowAuthModal(false); alert(`¬°Hola de nuevo, ${me.nombre}!`);
              } else {
                  console.log("Enviando Registro...", { email, nombre, apellido, pass });
                  if (!nombre || !apellido || !email || !pass) { alert("Por favor completa todos los campos."); return; }
                  await apiCall("/usuario/crear/", "POST", { correo: email, contrasena: pass, nombre: nombre, apellido: apellido, rol: "estudiante" });
                  alert("‚úÖ ¬°Cuenta creada con √©xito! Ahora inicia sesi√≥n."); setAuthMode("signin"); 
              }
          } catch (e) { console.error("Error Auth:", e); alert("‚ùå Error: " + e.message); }
      };

      const faqData = [{ q: "¬øC√≥mo hago un pedido de un favor?", a: "Simplemente navega por las categor√≠as, selecciona el favor que necesitas, y completa los detalles de recogida y entrega." }, { q: "¬øC√≥mo s√© d√≥nde est√° mi pedido?", a: "Puedes seguir el progreso de tu favor en tiempo real desde la secci√≥n \"Historial de Pedidos\" y ver la ubicaci√≥n del repartidor en el mapa." }, { q: "¬øQu√© m√©todos de pago aceptan?", a: "Solo pago en efectivo." }, { q: "¬øPuedo cancelar un favor?", a: "S√≠, puedes cancelar un favor desde la secci√≥n \"Historial de Pedidos\" siempre y cuando el repartidor a√∫n no haya confirmado la recogida." }, { isSeparator: true }, { q: "¬øC√≥mo me registro para hacer entregas?", a: "Haz clic en \"Reg√≠strate para hacer entregas\" en la p√°gina principal, completa tus datos (carnet estudiantil) y sube tu foto de perfil." }, { q: "¬øQu√© necesito para ser repartidor?", a: "Solo necesitas tu carnet estudiantil vigente y tiempo libre para aceptar favores." }, { q: "¬øC√≥mo acepto un favor?", a: "Cuando haya un favor disponible cerca, aparecer√° una notificaci√≥n. Haz clic en \"Aceptar\" y se te mostrar√° el mapa con las direcciones de recogida y entrega." }, { q: "¬øCu√°ndo recibo mi pago?", a: "Recibes el pago del favor en efectivo directamente del cliente al momento de completar la entrega." }];

      const renderHelpView = () => {
        return (
          <div className="min-h-screen bg-white">
            <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div className="flex items-center justify-between h-16"><button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors"><Menu /></button><div className="flex items-center gap-3">{isLoggedIn ? (<button className="p-2 hover:bg-gray-100 rounded-lg transition-colors"><User /></button>) : (<><button onClick={() => { setAuthMode("signin"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Sign in</button><button onClick={() => { setAuthMode("register"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg transition-colors">Register</button></>)}<div className="w-px h-8 bg-gray-300 mx-2" />
            
            {/* --- BOT√ìN CARRITO: Ahora abre el historial --- */}
            <button onClick={() => setIsCartOpen(!isCartOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative">
                <ShoppingCart />
            </button>
            
            </div></div></div>
              
              {/* --- POPUP HISTORIAL --- */}
              <OrderHistoryPopup 
                isOpen={isCartOpen} 
                onClose={() => setIsCartOpen(false)}
                currentUserId={currentUser?.id}
                onNavigateToFullHistory={() => {
                    setIsCartOpen(false);
                    setCurrentView("myOrders");
                }}
              />

              {showAuthModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-in zoom-in-95 duration-200"><div className="flex items-center justify-between p-6 pb-4"><h2 className="text-xl font-semibold text-gray-800">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</h2><button onClick={() => setShowAuthModal(false)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X /></button></div><div className="px-6 pb-6"><div className="space-y-4">
                        {authMode === "register" && (<><div><label className="block text-sm font-medium text-gray-700 mb-2">Nombre</label><input type="text" placeholder="Tu Nombre" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={nombre} onChange={e => setNombre(e.target.value)} /></div><div><label className="block text-sm font-medium text-gray-700 mb-2">Apellido</label><input type="text" placeholder="Tu Apellido" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={apellido} onChange={e => setApellido(e.target.value)} /></div></>)}
                      <div><label className="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" placeholder="nombre@ejemplo.com" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={email} onChange={e => setEmail(e.target.value)} /></div>
                      <div><label className="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label><input type="password" placeholder="********" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={pass} onChange={e => setPass(e.target.value)} /></div>
                      <button onClick={handleAuth} className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors mt-6">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</button>
                      {authMode === "signin" && (<div className="text-center mt-4"><button className="text-sm text-gray-600 hover:text-black transition-colors underline">¬øContrase√±a olvidada?</button></div>)}
                      <div className="text-center mt-6 pt-6 border-t border-gray-200"><p className="text-sm text-gray-600">{authMode === "signin" ? "¬øNo tienes cuenta?" : "¬øYa tienes cuenta?"} <button onClick={() => setAuthMode(authMode === "signin" ? "register" : "signin")} className="text-black font-medium hover:underline">{authMode === "signin" ? "Reg√≠strate" : "Inicia sesi√≥n"}</button></p></div>
                    </div></div></div></div>
              )}
              {menuOpen && (<div className="absolute top-16 left-0 w-64 bg-white shadow-lg border-t animate-in slide-in-from-left z-50"><nav className="py-2"><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("home"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Inicio</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("myOrders"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Mis pedidos</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("driverRegister"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ser repartidor</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("help"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ayuda</a></nav></div>)}
            </header>
            <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-8">
                {faqData.map((item, index) => {
                  if (item.isSeparator) { return (<div key={index} className="md:col-span-2 border-t border-gray-200 my-4"></div>); }
                  return (<React.Fragment key={index}><div className="flex flex-col justify-center"><h3 className="text-lg font-semibold text-gray-800 py-4 border-b border-gray-200">{item.q}</h3></div><div className="flex flex-col justify-center"><p className="text-gray-600 py-4 border-b border-gray-200">{item.a}</p></div></React.Fragment>);
                })}
              </div>
            </main>
          </div>
        );
      };

      if (currentView === "newFavor") { return <NewFavorView onGoBack={() => setCurrentView("home")} onNavigateToSendReceive={() => setCurrentView("sendReceive")} onNavigateToFastPrints={() => setCurrentView("fastPrints")} onNavigateToBuyTake={() => setCurrentView("buyTake")} />; }
      if (currentView === "sendReceive") { return <SendReceiveView onGoBack={() => setCurrentView("newFavor")} onNavigateToFastPrints={() => setCurrentView("fastPrints")} onNavigateToBuyTake={() => setCurrentView("buyTake")} />; }
      if (currentView === "fastPrints") { return <FastPrintsView onGoBack={() => setCurrentView("newFavor")} onNavigateToSendReceive={() => setCurrentView("sendReceive")} onNavigateToBuyTake={() => setCurrentView("buyTake")} />; }
      if (currentView === "buyTake") { return <BuyTakeView onGoBack={() => setCurrentView("newFavor")} onNavigateToSendReceive={() => setCurrentView("sendReceive")} onNavigateToFastPrints={() => setCurrentView("fastPrints")} />; }
      if (currentView === "driverRegister") { return <DriverRegisterView onGoBack={() => setCurrentView("home")} onNavigateToWelcome={() => setCurrentView("driverWelcome")} onSignIn={() => { setAuthMode("signin"); setShowAuthModal(true); }} onRegister={() => { setAuthMode("register"); setShowAuthModal(true); }} />; }
      if (currentView === "driverWelcome") { return <DriverWelcomeView onGoBack={() => setCurrentView("driverRegister")} onNavigateToProfilePhoto={() => setCurrentView("profilePhotoUpload")} onNavigateToCarnetPhoto={() => setCurrentView("carnetPhotoUpload")} />; }
      if (currentView === "profilePhotoUpload") { return <ProfilePhotoUploadView onGoBack={() => setCurrentView("driverWelcome")} />; }
      if (currentView === "carnetPhotoUpload") { return <CarnetPhotoUploadView onGoBack={() => setCurrentView("driverWelcome")} />; }
      if (currentView === "help") { return renderHelpView(); }
      if (currentView === "activeOrder") { return <ActiveOrderView orderId={activeOrderId} userRole={currentUser?.rol} onGoBack={() => { setIgnoredOrderId(activeOrderId); setCurrentView("home"); }} />; }
      if (currentView === "driverFeed") { return <DriverFeedView onGoBack={() => setCurrentView("home")} onNavigateToActiveOrder={(id) => { setActiveOrderId(id); setCurrentView("activeOrder"); }} />; }
      if (currentView === "myOrders") { return <MyOrdersView onGoBack={() => setCurrentView("home")} currentUserId={currentUser?.id} onNavigateToActiveOrder={(id) => { setActiveOrderId(id); setCurrentView("activeOrder"); }} />; }

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white shadow-sm sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex items-center justify-between h-16">
                <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors"><Menu /></button>
                <div className="flex items-center gap-3">
                  {isLoggedIn ? (
                    <div className="relative">
                      <button onClick={() => setShowUserMenu(!showUserMenu)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2"><User /><span className="text-sm font-medium hidden sm:block">{currentUser?.nombre || "Usuario"}</span></button>
                      {showUserMenu && (<div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-100 z-50 animate-in fade-in zoom-in-95"><div className="py-1"><button className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mi Perfil</button><button onClick={handleLogout} className="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Cerrar Sesi√≥n</button></div></div>)}
                    </div>
                  ) : (
                    <><button onClick={() => { setAuthMode("signin"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Sign in</button><button onClick={() => { setAuthMode("register"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg transition-colors">Register</button></>
                  )}
                  <div className="w-px h-8 bg-gray-300 mx-2" />
                  
                  {/* --- BOT√ìN CARRITO: Abre el popup --- */}
                  <button onClick={() => setIsCartOpen(!isCartOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative">
                    <ShoppingCart />
                  </button>
                
                </div>
              </div>
            </div>
            
            {/* --- POPUP HISTORIAL --- */}
            <OrderHistoryPopup 
                isOpen={isCartOpen} 
                onClose={() => setIsCartOpen(false)}
                currentUserId={currentUser?.id}
                onNavigateToFullHistory={() => {
                    setIsCartOpen(false);
                    setCurrentView("myOrders");
                }}
            />

            {showAuthModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-in zoom-in-95 duration-200">
                  <div className="flex items-center justify-between p-6 pb-4"><h2 className="text-xl font-semibold text-gray-800">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</h2><button onClick={() => setShowAuthModal(false)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X /></button></div>
                  <div className="px-6 pb-6">
                    <div className="space-y-4">
                        {authMode === "register" && (<><div><label className="block text-sm font-medium text-gray-700 mb-2">Nombre</label><input type="text" placeholder="Tu Nombre" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none" value={nombre} onChange={e => setNombre(e.target.value)} /></div><div><label className="block text-sm font-medium text-gray-700 mb-2">Apellido</label><input type="text" placeholder="Tu Apellido" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none" value={apellido} onChange={e => setApellido(e.target.value)} /></div></>)}
                      <div><label className="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" placeholder="nombre@ejemplo.com" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={email} onChange={e => setEmail(e.target.value)} /></div>
                      <div><label className="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label><input type="password" placeholder="********" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={pass} onChange={e => setPass(e.target.value)} /></div>
                      <button onClick={handleAuth} className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors mt-6">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</button>
                      {authMode === "signin" && (<div className="text-center mt-4"><button className="text-sm text-gray-600 hover:text-black transition-colors underline">¬øContrase√±a olvidada?</button></div>)}
                      <div className="text-center mt-6 pt-6 border-t border-gray-200"><p className="text-sm text-gray-600">{authMode === "signin" ? "¬øNo tienes cuenta?" : "¬øYa tienes cuenta?"} <button onClick={() => setAuthMode(authMode === "signin" ? "register" : "signin")} className="text-black font-medium hover:underline">{authMode === "signin" ? "Reg√≠strate" : "Inicia sesi√≥n"}</button></p></div>
                    </div>
                  </div>
                </div>
              </div>
            )}
            {menuOpen && (<div className="absolute top-16 left-0 w-64 bg-white shadow-lg border-t animate-in slide-in-from-left z-50"><nav className="py-2"><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("home"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Inicio</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("myOrders"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Mis pedidos</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("driverRegister"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ser repartidor</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("help"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ayuda</a></nav></div>)}
          </header>
          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div className="relative rounded-2xl overflow-hidden mb-12 h-64 sm:h-80 animate-in fade-in slide-in-from-bottom-4 duration-700" style={{ animationDelay: "100ms" }}>
              <div className="absolute inset-0 bg-gradient-to-br from-amber-400 via-orange-300 to-amber-200"><div className="absolute inset-0 opacity-20"><div className="absolute top-10 right-20 w-32 h-32 bg-white rounded-full blur-3xl"></div><div className="absolute bottom-20 left-10 w-40 h-40 bg-orange-500 rounded-full blur-3xl"></div></div><div className="absolute bottom-0 left-0 w-full h-full flex items-end justify-start pl-12"><div className="relative w-48 h-64"><div className="absolute top-8 left-12 w-16 h-16 bg-amber-900 rounded-full"></div><div className="absolute top-20 left-14 w-12 h-8 bg-amber-950 rounded-b-full"></div><div className="absolute top-24 left-4 w-32 h-40 bg-gradient-to-b from-yellow-500 to-yellow-600 rounded-t-3xl"></div><div className="absolute top-20 left-8 w-24 h-20 bg-yellow-600 rounded-t-full"></div></div></div></div>
              <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-transparent" />
              <div className="relative h-full flex flex-col justify-center px-8 sm:px-12"><h1 className="text-4xl sm:text-5xl font-bold text-white mb-3 animate-in slide-in-from-left duration-700" style={{ animationDelay: "150ms" }}>Pide tu favor ahora.</h1><p className="text-lg sm:text-xl text-white/90 animate-in slide-in-from-left duration-700" style={{ animationDelay: "300ms" }}>Solo pago en efectivo</p></div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden animate-in fade-in slide-in-from-bottom-4" style={{ animationDelay: "150ms" }}>
                <div className="h-48 relative overflow-hidden bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50"><div className="absolute inset-0 flex items-center justify-center"><div className="relative mr-8"><div className="w-16 h-20 bg-amber-200 rounded-t-full rounded-b-lg transform -rotate-12"></div><div className="absolute -top-3 left-2 w-3 h-8 bg-amber-200 rounded-full transform -rotate-12"></div><div className="absolute -top-4 left-5 w-3 h-10 bg-amber-200 rounded-full transform rotate-3"></div><div className="absolute -top-3 left-8 w-3 h-9 bg-amber-200 rounded-full transform rotate-12"></div><div className="absolute -top-2 left-11 w-3 h-7 bg-amber-200 rounded-full transform rotate-20"></div><div className="absolute -bottom-6 left-4 w-8 h-8 bg-amber-300 rounded"></div></div><div className="relative ml-8"><div className="w-16 h-20 bg-rose-200 rounded-t-full rounded-b-lg transform rotate-12"></div><div className="absolute -top-3 right-2 w-3 h-8 bg-rose-200 rounded-full transform rotate-12"></div><div className="absolute -top-4 right-5 w-3 h-10 bg-rose-200 rounded-full transform -rotate-3"></div><div className="absolute -top-3 right-8 w-3 h-9 bg-rose-200 rounded-full transform -rotate-12"></div><div className="absolute -top-2 right-11 w-3 h-7 bg-rose-200 rounded-full transform -rotate-20"></div><div className="absolute -bottom-6 right-4 w-8 h-8 bg-rose-300 rounded"></div></div><div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"><Hand className="w-8 h-8 text-purple-400 opacity-50 animate-pulse" /></div></div><div className="absolute top-8 left-8 w-2 h-2 bg-yellow-400 rounded-full animate-bounce"></div><div className="absolute top-12 right-12 w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{ animationDelay: "75ms" }}></div><div className="absolute bottom-12 left-16 w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{ animationDelay: "150ms" }}></div></div>
                <div className="p-6"><h3 className="text-lg font-semibold text-gray-800 mb-2">Pide favores para mejorar tu comodidad.</h3><button onClick={() => setCurrentView("newFavor")} className="mt-4 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">Pedir favor</button></div>
              </div>
              <div className="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden animate-in fade-in slide-in-from-bottom-4" style={{ animationDelay: "300ms" }}> 
                <div className="h-48 bg-gradient-to-br from-orange-50 to-orange-100 flex items-center justify-center"><UserPlus className="w-32 h-32 text-orange-500" /></div>
                <div className="p-6"><h3 className="text-lg font-semibold text-gray-800 mb-2">√önete como repartidor</h3><p className="text-sm text-gray-600 mb-4">Genera ingresos en tu tiempo libre. S√© tu propio jefe y conectate para repartir cuando y c√≥mo quieras.</p><button onClick={() => setCurrentView("driverRegister")} className="mt-2 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">Quiero trabajar</button></div>
              </div>
            </div>
            {isLoggedIn && currentUser?.rol === "repartidor" && (<div className="mt-8 bg-black rounded-xl p-8 text-white text-center shadow-xl animate-in slide-in-from-bottom-4"><h2 className="text-2xl font-bold mb-2">üöó Modo Repartidor</h2><p className="mb-6 opacity-90">Tienes {currentUser.nombre}, revisa los pedidos disponibles.</p><button onClick={() => setCurrentView("driverFeed")} className="bg-white text-black px-8 py-3 rounded-full font-bold hover:bg-gray-200 transition-colors">Ver Pedidos Disponibles</button></div>)}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<HomePage />);
    
  </script>
</body>
</html>