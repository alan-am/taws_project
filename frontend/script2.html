<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web de Favores</title>
  <style>
    /* Esto oculta la cajita blanca de instrucciones que tapa el mapa */
    .leaflet-routing-container { display: none !important; }
  </style>
  <style>
    /* Ocultar la caja blanca de instrucciones de manejo que sale en el mapa */
    .leaflet-routing-container { display: none !important; }
  </style> 

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- React y ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- Babel (para JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Usar la fuente Inter como en el dise√±o original */
    body {
      font-family: "Inter", sans-serif;
    }

    /* Definiciones manuales para las animaciones de tailwindcss-animate */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes zoomIn95 {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes slideInFromLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInFromBottom4 {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation-duration: 150ms;
      animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .fade-in { animation-name: fadeIn; }
    .zoom-in-95 { animation-name: zoomIn95; }
    .slide-in-from-left { animation-name: slideInFromLeft; }
    .slide-in-from-bottom-4 { animation-name: slideInFromBottom4; }

    /* --- TUS ESTILOS PERSONALIZADOS (Adaptados) --- */
    
    .recorrido-view {
        font-family: "Arial", sans-serif;
        background-color: #fff;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        width: 100%;
    }

    .tracking-container {
        width: 100%;
        max-width: 800px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .recorrido-view h1 {
        font-size: 32px;
        font-weight: 900;
        margin-top: 20px;
        margin-bottom: 30px;
        text-align: center;
        color: #000;
    }

    .map-container {
        width: 100%;
        max-width: 500px;
        height: 250px;
        background-color: #eee;
        margin-bottom: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .info-section {
        display: flex;
        justify-content: center;
        gap: 40px;
        width: 100%;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }

    .card-custom {
        border: 1px solid #ccc;
        padding: 20px 30px;
        width: 100%;
        max-width: 300px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .card-custom h2 {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 25px;
        color: #000;
    }

    .card-custom p {
        font-size: 16px;
        font-weight: bold;
        margin: 15px 0;
        color: #000;
    }

    .btn-delivered {
        background-color: #2c2c2c;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .btn-delivered:hover {
        background-color: #000;
    }
    
    .btn-back-float {
        position: absolute;
        top: 20px;
        left: 20px;
        cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script> 
</head>
<body>
  <!-- Contenedor ra√≠z para la app React -->
  <div id="root"></div>

  <!-- Script de React (JSX) -->
  <script type="text/babel">
  const { useState, useRef, useEffect } = React;

    // --- AGREGA ESTO JUSTO DEBAJO ---
    const uploadToCloudinary = async (file, tipo) => {
        const formData = new FormData();
        formData.append('imagen', file);
        formData.append('tipo', tipo); // 'perfil' o 'carnet'

        const token = localStorage.getItem("accessToken");
        try {
            const response = await fetch(`${API_BASE_URL}/usuario/subir-imagen/`, {
                method: 'POST',
                headers: {
                    // NO poner 'Content-Type': 'application/json' aqu√≠, el navegador lo pone solo para FormData
                    ...(token && { "Authorization": `Bearer ${token}` })
                },
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Error subiendo imagen");
            }
            
            const data = await response.json();
            return data.url; // Retorna la URL real de Cloudinary
        } catch (error) {
            console.error("Upload error:", error);
            throw error;
        }
    };
    // --- CONFIGURACI√ìN CENTRAL (NUEVA) ---
    const API_BASE_URL = "http://192.168.3.114:8000/api"; 

    // --- 1. FUNCIONES DE AYUDA Y MATEM√ÅTICAS ---
    
    const apiCall = async (endpoint, method = "GET", body = null) => {
      const token = localStorage.getItem("accessToken");
      const headers = { 
        "Content-Type": "application/json", 
        ...(token && { "Authorization": `Bearer ${token}` }) 
      };
      
      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { 
          method, 
          headers, 
          ...(body && { body: JSON.stringify(body) }) 
        });
        
        if (response.status === 401) { 
          console.warn("Sesi√≥n expirada"); 
          localStorage.removeItem("accessToken"); 
          throw new Error("Sesi√≥n expirada");
        }
        
        if (response.status === 204) return true;
        
        // ‚úÖ NUEVO: Verifica si la respuesta es JSON
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          const text = await response.text();
          console.error("Respuesta no es JSON:", text.substring(0, 200));
          throw new Error("El servidor devolvi√≥ HTML en lugar de JSON. Revisa la consola de Django.");
        }
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.detail || JSON.stringify(data));
        }
        
        return data;
      } catch (error) { 
        console.error("API Error:", error); 
        throw error; 
      }
    };

    //----funcion api para la subida de imagenes con el back
    const uploadImageApi = async (file, folderType) => {
      const formData = new FormData();
      formData.append('imagen', file);
      formData.append('tipo', folderType); // 'perfil' o 'carnet'

      try {
        const response = await fetch(`${API_BASE_URL}/usuario/subir-imagen/`, {
          method: 'POST',
          body: formData, // Fetch detecta FormData y pone el Content-Type correcto autom√°ticamente
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Error subiendo imagen");
        return data.url; // Retornamos la URL segura de Cloudinary
      } catch (error) {
        console.error("Upload Error:", error);
        throw error;
      }
    };
    //------


    // Matem√°ticas para la cotizaci√≥n en tiempo real
    const deg2rad = (deg) => deg * (Math.PI / 180);

    const getDistanceFromLatLonInKm = (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Radio de la tierra en km
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; 
    };

    const parseCoordinates = (str) => {
        if (!str || typeof str !== 'string' || !str.includes("Ubicaci√≥n:")) return null;
        try {
            const parts = str.replace("Ubicaci√≥n:", "").trim().split(",");
            if (parts.length === 2) return { lat: parseFloat(parts[0]), lng: parseFloat(parts[1]) };
        } catch (e) { return null; }
        return null;
    };

    // --- Iconos ---
    const IconProps = { className: "w-6 h-6 text-gray-700", strokeWidth: 2, fill: "none", stroke: "currentColor", strokeLinecap: "round", strokeLinejoin: "round" };
    const Menu = () => (<svg {...IconProps}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>);
    const ShoppingCart = () => (<svg {...IconProps}><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>);
    const User = () => (<svg {...IconProps}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
    const X = () => (<svg {...IconProps} className="w-5 h-5 text-gray-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
    const ArrowLeft = () => (<svg {...IconProps}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>);
    const ChevronUp = () => (<svg {...IconProps} className="w-5 h-5"><polyline points="18 15 12 9 6 15"></polyline></svg>);
    const ChevronDown = () => (<svg {...IconProps} className="w-5 h-5 text-gray-400"><polyline points="6 9 12 15 18 9"></polyline></svg>);
    const ChevronRight = () => (<svg {...IconProps} className="w-5 h-5 text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>);
    const Hand = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2z"></path></svg>);
    const UserPlus = ({ className }) => (<svg className={className} strokeWidth="1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>);
    const Plus = ({ className }) => (<svg {...IconProps} className={className || "w-5 h-5"}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
    const Trash = ({ className }) => (<svg {...IconProps} className={className || "w-6 h-6 text-gray-500 hover:text-red-600"}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
    const Walk = ({ className }) => (<svg className={className} strokeWidth="2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 19l-4-4l-1-7h10l-1 7l-4 4z"></path><circle cx="12" cy="5" r="2"></circle></svg>);
    const Check = ({ className }) => (<svg className={className} strokeWidth="3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>);
    const HelpCircle = () => (<svg {...IconProps} className="w-5 h-5 text-white"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
    const IdCard = ({ className }) => (<svg className={className} strokeWidth="1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"></rect><circle cx="8" cy="10" r="2"></circle><path d="M12 12c-2.5 0-5 1.5-5 3v2h10v-2c0-1.5-2.5-3-5-3z"></path><line x1="14" y1="8" x2="19" y2="8"></line><line x1="14" y1="11" x2="19" y2="11"></line></svg>);
    const Settings = ({ className }) => (<svg className={className || "w-6 h-6 text-gray-700"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>);
    const Phone = ({ className }) => (<svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>);
    const WhatsApp = ({ className }) => (<svg className={className || "w-6 h-6"} viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>);
    const PickupIcon = ({ className }) => (<svg className={className || "w-6 h-6"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle><path d="M16 3l4 4-4 4"></path></svg>);
    const DropoffIcon = ({ className }) => (<svg className={className || "w-6 h-6"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>);
    // Icono espec√≠fico para el repartidor en el historial
    const DeliveryIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" />
        <circle cx="12" cy="10" r="3" />
      </svg>
    );

    function DropdownMenu({ options, onSelect }) {
      return (
        <div className="absolute top-full left-0 mt-1 w-full bg-white rounded-lg shadow-2xl border border-gray-100 z-20 animate-in fade-in zoom-in-95">
          <div className="py-1 max-h-48 overflow-y-auto">
            {options.map((option) => (
              <button key={option} onClick={() => onSelect(option)} className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                {option}
              </button>
            ))}
          </div>
        </div>
      );
    }
    
    // --- COMPONENTE: Modal de Confirmaci√≥n ---
    function ConfirmacionModal({ onClose, servicio, desde, hasta, hora, onConfirmAction, costoBase }) {
      const [loading, setLoading] = useState(false);
      
      // --- L√ìGICA CONECTADA AL BACKEND ---
      // El 'costoBase' viene calculado desde el servidor (precios_dinamicos.py)
      // En el backend definimos la Tarifa Base en $0.50, as√≠ que usamos eso para el desglose.
      const tarifaArrancar = 0.50; 
      const total = costoBase !== undefined ? parseFloat(costoBase) : 0;
      
      // Calculamos cu√°nto es de env√≠o restando la base
      const envioDistancia = Math.max(0, total - tarifaArrancar);

      const handleFinalConfirm = async () => {
        if (!onConfirmAction) return;
        setLoading(true);
        try {
            await onConfirmAction(); // Ejecuta la acci√≥n de crear pedido
            onClose();
        } catch (error) { console.error(error); } finally { setLoading(false); }
      };
      
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-in fade-in backdrop-blur-sm">
          <div className="bg-white rounded-[20px] shadow-2xl w-full max-w-sm mx-auto relative p-6 animate-in zoom-in-95 font-sans">
            
            <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full transition-colors"><X /></button>

            <h2 className="text-xl font-bold text-center text-black mb-6">Confirmar Pedido</h2>
            
            {/* SECCI√ìN: TU REPARTIDOR (Dise√±o del Main) */}
            <div className="mb-4">
                <h3 className="text-sm font-bold text-black mb-2">Tu Repartidor</h3>
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center bg-gray-50">
                        <User className="w-6 h-6 text-gray-400" />
                    </div>
                    <span className="text-gray-400 text-sm font-medium">Por asignar...</span>
                </div>
                <div className="h-px bg-gray-200 mt-4"></div>
            </div>

            {/* SECCI√ìN: DETALLES */}
            <div className="space-y-1 mb-4 text-sm">
              <div className="flex"><span className="font-bold text-black w-24">Desde:</span> <span className="text-black truncate flex-1">{desde || "..."}</span></div>
              <div className="flex"><span className="font-bold text-black w-24">Hasta:</span> <span className="text-black truncate flex-1">{hasta || "..."}</span></div>
              <div className="flex"><span className="font-bold text-black w-24">Hora:</span> <span className="text-black truncate flex-1">{hora || "--:--"}</span></div>
              <div className="flex"><span className="font-bold text-black w-24">Servicio:</span> <span className="text-black truncate flex-1">{servicio}</span></div>
            </div>

            {/* SECCI√ìN: C√ìDIGO √öNICO (Placeholder Visual) */}
            <div className="mb-4">
                <p className="text-sm font-bold text-black mb-1">C√≥digo √∫nico:</p>
                <div className="bg-gray-50 px-3 py-2 rounded border border-gray-200 text-xs text-gray-400 font-mono">
                    PENDIENTE DE ASIGNACI√ìN
                </div>
            </div>

            {/* --- AQU√ç EST√Å LA FACTURA GRIS (Dise√±o Original del Main) --- */}
            <div className="bg-[#D9D9D9] rounded-xl p-5 mb-6 space-y-2">
                <div className="flex justify-between items-center text-sm font-medium text-black">
                    <span>Costo del producto:</span>
                    <span>-</span> {/* En env√≠os normales no hay producto */}
                </div>
                <div className="flex justify-between items-center text-sm font-medium text-black">
                    <span>Tarifa por arrancar:</span>
                    <span>${tarifaArrancar.toFixed(2)}</span>
                </div>
                <div className="flex justify-between items-center text-sm font-medium text-black">
                    <span>Envi√≥ por distancia:</span>
                    <span>${envioDistancia.toFixed(2)}</span>
                </div>
                <div className="w-full h-px bg-gray-400 my-2"></div>
                <div className="flex justify-between items-center font-bold text-lg text-black">
                    <span>Total:</span>
                    <span>${total.toFixed(2)}</span>
                </div>
            </div>
            {/* ----------------------------------------------------------- */}

            <div className="flex justify-center">
                <button 
                    onClick={handleFinalConfirm} 
                    disabled={loading} 
                    className="bg-[#2D2D2D] text-white px-12 py-3 rounded-lg font-medium text-sm hover:bg-black transition-colors shadow-lg disabled:opacity-70"
                >
                    {loading ? "Procesando..." : "Confirmar"}
                </button>
            </div>

          </div>
        </div>
      );
    }

        // Modal de Notificaci√≥n Push para Repartidor
    function IncomingOrderModal({ order, onAccept, onReject }) {
      if (!order) return null;
      const tarifaArrancar = 0.50;
      const total = parseFloat(order.costoEnvio) || 0;
      const envioDistancia = Math.max(0, total - tarifaArrancar); 
      const recogidaTexto = order.punto_origen || "Origen no especificado";
      const entregaTexto = order.punto_destino || "Destino no especificado";

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4 animate-in fade-in backdrop-blur-sm">
            <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-xs mx-auto relative overflow-hidden animate-in zoom-in-95 border border-gray-200">
                <div className="p-6 relative z-10">
                    <h2 className="text-2xl font-black text-center text-black mb-6">Nuevo Pedido.</h2>
                    <div className="bg-[#D9D9D9] rounded-xl p-4 mb-6 relative">
                        <div className="space-y-2 text-sm font-medium text-black">
                            <div className="flex justify-between"><span>Tarifa por arrancar:</span><span>${tarifaArrancar.toFixed(2)}</span></div>
                            <div className="flex justify-between"><span>Env√≠o por distancia:</span><span>${envioDistancia.toFixed(2)}</span></div>
                        </div>
                        <div className="mt-3 pt-2 border-t border-gray-400/50 flex justify-between items-end"><span className="font-bold text-lg text-black">Total:</span><span className="font-black text-2xl text-black">${total.toFixed(2)}</span></div>
                    </div>
                    <div className="space-y-4 mb-8 px-1">
                        <div className="flex items-center gap-3"><div className="p-1 bg-gray-100 rounded-full border border-gray-300"><PickupIcon className="w-5 h-5 text-gray-700" /></div><div><p className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Recogida:</p><p className="text-sm font-bold text-gray-900 leading-tight">{recogidaTexto}</p></div></div>
                        <div className="flex items-center gap-3"><div className="p-1 bg-gray-100 rounded-full border border-gray-300"><DropoffIcon className="w-5 h-5 text-gray-700" /></div><div><p className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Entrega:</p><p className="text-sm font-bold text-gray-900 leading-tight">{entregaTexto}</p></div></div>
                        <div className="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600 italic border border-gray-100">"{order.descripcion}"</div>
                    </div>
                    <div className="space-y-3">
                        <button onClick={() => onAccept(order.codigoPedido)} className="w-full bg-[#2c2c2c] text-white py-3 rounded-lg font-bold text-sm hover:bg-black transition-colors shadow-lg">Confirmar</button>
                        <button onClick={onReject} className="w-full bg-[#2c2c2c] text-white py-3 rounded-lg font-bold text-sm hover:bg-black transition-colors shadow-lg">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
      );
    }


    // Modal de Confirmaci√≥n Manual cuando el repartidor selecciona de la lista
    function DriverAcceptanceModal({ order, onConfirm, onCancel }) {
      if (!order) return null;
      const tarifaArrancar = 0.50;
      const total = parseFloat(order.costoEnvio) || 0;
      const envioDistancia = Math.max(0, total - tarifaArrancar); 
      const recogidaTexto = order.punto_origen || "Origen no especificado";
      const entregaTexto = order.punto_destino || "Destino no especificado";

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4 animate-in fade-in backdrop-blur-sm">
            <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-xs mx-auto relative overflow-hidden animate-in zoom-in-95 border border-gray-200">
                <div className="p-6 relative z-10">
                    <h2 className="text-2xl font-black text-center text-black mb-6">Confirmar Pedido</h2>
                    <div className="bg-[#D9D9D9] rounded-xl p-4 mb-6 relative">
                        <div className="space-y-2 text-sm font-medium text-black">
                            <div className="flex justify-between"><span>Tarifa por arrancar:</span><span>${tarifaArrancar.toFixed(2)}</span></div>
                            <div className="flex justify-between"><span>Env√≠o por distancia:</span><span>${envioDistancia.toFixed(2)}</span></div>
                        </div>
                        <div className="mt-3 pt-2 border-t border-gray-400/50 flex justify-between items-end"><span className="font-bold text-lg text-black">Total:</span><span className="font-black text-2xl text-black">${total.toFixed(2)}</span></div>
                    </div>
                    <div className="space-y-4 mb-8 px-1">
                        <div className="flex items-center gap-3"><div className="p-1 bg-gray-100 rounded-full border border-gray-300"><PickupIcon className="w-5 h-5 text-gray-700" /></div><div><p className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Recogida:</p><p className="text-sm font-bold text-gray-900 leading-tight">{recogidaTexto}</p></div></div>
                        <div className="flex items-center gap-3"><div className="p-1 bg-gray-100 rounded-full border border-gray-300"><DropoffIcon className="w-5 h-5 text-gray-700" /></div><div><p className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Entrega:</p><p className="text-sm font-bold text-gray-900 leading-tight">{entregaTexto}</p></div></div>
                        <div className="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600 italic border border-gray-100">"{order.descripcion}"</div>
                    </div>
                    <div className="space-y-3">
                        <button onClick={() => onConfirm(order.codigoPedido)} className="w-full bg-[#2c2c2c] text-white py-3 rounded-lg font-bold text-sm hover:bg-black transition-colors shadow-lg">Confirmar</button>
                        <button onClick={onCancel} className="w-full bg-[#2c2c2c] text-white py-3 rounded-lg font-bold text-sm hover:bg-black transition-colors shadow-lg">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
      );
    }

    // Modal de Edici√≥n de Perfil para Estudiantes
    function ProfileEditModal({ user, onClose, onUpdateUser }) {
      const [formData, setFormData] = useState({ 
        nombre: user?.nombre || "", 
        apellido: user?.apellido || "", 
        telefono: user?.telefono || "", 
        whatsapp: user?.telefono || "" 
      });
      const [loading, setLoading] = useState(false);
      
      const handleChange = (e) => { 
        setFormData({ ...formData, [e.target.name]: e.target.value }); 
      };
      
      const handleSubmit = async () => { 
        setLoading(true); 
        try { 
          await apiCall(`/usuario/actualizar/${user.id}/`, 'PATCH', { 
            nombre: formData.nombre, 
            apellido: formData.apellido, 
            telefono: formData.telefono 
          }); 
          alert("‚úÖ Perfil actualizado correctamente"); 
          onUpdateUser(); 
          onClose(); 
        } catch (error) { 
          console.error(error); 
          alert("Error al actualizar: " + error.message); 
        } finally { 
          setLoading(false); 
        } 
      };
      
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4 animate-in fade-in backdrop-blur-sm">
          <div className="bg-white rounded-[30px] shadow-2xl w-full max-w-sm mx-auto relative p-8 animate-in zoom-in-95">
            <button onClick={onClose} className="absolute top-6 right-6 p-2 hover:bg-gray-100 rounded-full transition-colors">
              <X className="w-6 h-6 text-black" />
            </button>
            <div className="flex flex-col items-center mb-8">
              <div className="w-24 h-24 rounded-full bg-[#EFE6FD] flex items-center justify-center text-[#5B21B6] overflow-hidden border-4 border-white shadow-md mb-4">
                {user?.foto_perfil ? (
                  <img src={user.foto_perfil} className="w-full h-full object-cover" alt="Perfil" />
                ) : (
                  <User className="w-12 h-12" />
                )}
              </div>
              <h2 className="text-3xl font-bold text-black">Perfil</h2>
            </div>
            <div className="space-y-4 mb-8">
              <div className="bg-[#D9D9D9] rounded-lg flex items-center px-4 py-3">
                <User className="w-6 h-6 text-black mr-3" />
                <input type="text" name="nombre" value={formData.nombre} onChange={handleChange} placeholder="Nombre" className="bg-transparent border-none outline-none text-black w-full placeholder-gray-600"/>
              </div>
              <div className="bg-[#D9D9D9] rounded-lg flex items-center px-4 py-3">
                <User className="w-6 h-6 text-black mr-3 opacity-0" />
                <input type="text" name="apellido" value={formData.apellido} onChange={handleChange} placeholder="Apellido" className="bg-transparent border-none outline-none text-black w-full placeholder-gray-600"/>
              </div>
              <div className="bg-[#D9D9D9] rounded-lg flex items-center px-4 py-3">
                <Phone className="w-6 h-6 text-black mr-3" />
                <input type="tel" name="telefono" value={formData.telefono} onChange={handleChange} placeholder="Numero de tel√©fono" className="bg-transparent border-none outline-none text-black w-full placeholder-gray-600"/>
              </div>
              <div className="bg-[#D9D9D9] rounded-lg flex items-center px-4 py-3">
                <WhatsApp className="w-6 h-6 text-black mr-3" />
                <input type="tel" name="whatsapp" value={formData.whatsapp} onChange={handleChange} placeholder="Numero de whatsapp" className="bg-transparent border-none outline-none text-black w-full placeholder-gray-600"/>
              </div>
            </div>
            <button onClick={handleSubmit} disabled={loading} className="w-full bg-[#E31C1C] text-white py-3 rounded-xl font-medium text-lg hover:bg-red-700 transition-colors shadow-md disabled:opacity-50">
              {loading ? "Guardando..." : "Guardar cambios"}
            </button>
          </div>
        </div>
      );
    }

    // Men√∫ Dropdown adaptativo por rol
    function UserMenuDropdown({ user, onClose, onLogout, onOpenProfile, onToggleOnline }) {
      const isDriver = user?.rol === 'repartidor';
      
      return (
        <div className="absolute right-0 top-full mt-4 w-80 bg-white rounded-[2rem] shadow-2xl border border-gray-100 z-50 animate-in fade-in zoom-in-95 overflow-hidden ring-1 ring-black/5">
          <div className="p-6 relative">
            <button onClick={onClose} className="absolute top-5 right-5 text-black hover:text-gray-600 transition-colors">
              <X className="w-6 h-6" />
            </button>
            <div className="flex items-center gap-4 mb-8 pr-8">
              <div className="flex-shrink-0 w-16 h-16 rounded-full bg-[#EFE6FD] flex items-center justify-center text-[#5B21B6] overflow-hidden border-2 border-white shadow-sm">
                {user?.foto_perfil ? (
                  <img src={user.foto_perfil} className="w-full h-full object-cover" alt="Perfil" />
                ) : (
                  <User className="w-8 h-8" />
                )}
              </div>
              <div className="flex flex-col">
                <h3 className="text-2xl font-bold text-black leading-none mb-1">Mi cuenta.</h3>
                <p className="text-sm text-gray-600 font-medium">Hola, {isDriver ? "Repartidor" : (user?.nombre || "Estudiante")}.</p>
              </div>
            </div>
            <div className="space-y-5 mb-8">
              <button onClick={() => { 
                  console.log("üîµ Click en Mi perfil"); 
                  console.log("üîµ user:", user);
                  onClose(); 
                  onOpenProfile(); 
              }} className="flex items-center gap-4 w-full text-left group hover:bg-gray-50 rounded-lg -mx-2 px-2 py-1 transition-colors">
                <User className="w-7 h-7 text-black group-hover:text-gray-700" />
                <span className="text-lg text-black font-medium group-hover:text-gray-700">Mi perfil</span>
              </button>
              {!isDriver && (
                <button className="flex items-center gap-4 w-full text-left group hover:bg-gray-50 rounded-lg -mx-2 px-2 py-1 transition-colors">
                  <ShoppingCart className="w-7 h-7 text-black group-hover:text-gray-700" />
                  <span className="text-lg text-black font-medium group-hover:text-gray-700">Mi carrito</span>
                </button>
              )}
              <button className="flex items-center gap-4 w-full text-left group hover:bg-gray-50 rounded-lg -mx-2 px-2 py-1 transition-colors">
                <Settings className="w-7 h-7 text-black group-hover:text-gray-700" />
                <span className="text-lg text-black font-medium group-hover:text-gray-700">Configuraci√≥n</span>
              </button>
            </div>
            {isDriver && (
              <div className="mb-8 flex items-center justify-between pl-1">
                <div 
                    onClick={onToggleOnline} 
                    className={`w-14 h-8 rounded-full p-1 cursor-pointer transition-colors duration-300 ${user?.disponible ? 'bg-green-600' : 'bg-red-600'}`}
                >
                    <div className={`bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300 ${user?.disponible ? 'translate-x-6' : 'translate-x-0'}`}></div>
                </div>
                <span className="text-lg text-black font-medium mr-4">
                    {user?.disponible ? "Recibiendo pedidos" : "Desconectado"}
                </span>
              </div>
            )}
            <button onClick={onLogout} className="w-full bg-[#E31C1C] text-white py-3.5 rounded-xl font-bold text-lg hover:bg-red-700 transition-colors shadow-md">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      );
    }

    // --- NUEVO COMPONENTE: Popover de Historial de Pedidos ---
    function OrderHistoryPopup({ isOpen, onClose, onNavigateToFullHistory, currentUserId }) {
        const [orders, setOrders] = useState([]);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            if (isOpen && currentUserId) {
                const fetchOrders = async () => {
                    setLoading(true);
                    try {
                        const data = await apiCall("/pedido/listar/");
                        // Filtramos por usuario y ordenamos descendente (m√°s reciente primero)
                        // Mostramos solo los √∫ltimos 3 pedidos para el popup
                        const myOrders = data.filter(o => o.idCliente === currentUserId).reverse().slice(0, 3);
                        setOrders(myOrders);
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchOrders();
            }
        }, [isOpen, currentUserId]);

        if (!isOpen) return null;

        const getStatusStyle = (status) => {
            // Mapeo de estados del backend a los colores de la imagen
            switch (status) {
                case "Entregado": return "bg-green-500 text-white"; // Completado (Verde)
                case "Aceptado": return "bg-orange-500 text-white"; // En curso (Naranja)
                case "Publicado": return "bg-orange-500 text-white"; // En curso/Pendiente (Naranja)
                default: return "bg-red-500 text-white"; // Asumimos Cancelado u otro como Rojo
            }
        };

        const getStatusText = (status) => {
             switch (status) {
                case "Entregado": return "Completado";
                case "Aceptado": return "En curso";
                case "Publicado": return "En curso"; // O "Pendiente"
                default: return "Cancelado";
            }
        };

        return (
            <div className="absolute top-16 right-4 w-full max-w-sm bg-white shadow-2xl rounded-xl border border-gray-100 overflow-hidden z-50 animate-in fade-in zoom-in-95">
                <div className="flex items-center justify-between p-4 border-b border-gray-100">
                    <h3 className="font-bold text-xl text-black">Historial de pedidos</h3>
                    <button onClick={onClose}><X className="w-6 h-6 text-black hover:text-gray-600" /></button>
                </div>
                
                <div className="max-h-96 overflow-y-auto">
                    {loading ? (
                        <div className="p-6 text-center text-gray-500">Cargando...</div>
                    ) : orders.length === 0 ? (
                        <div className="p-6 text-center text-gray-500">No tienes pedidos recientes.</div>
                    ) : (
                        <div className="divide-y divide-purple-100"> {/* Linea divisoria sutil como en la imagen */}
                            {orders.map(order => (
                                <div key={order.codigoPedido} className="p-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className="flex-shrink-0">
                                            {/* Icono de repartidor/paquete similar a la imagen */}
                                            <div className="border border-black rounded-lg p-1">
                                                <DeliveryIcon className="w-8 h-8 text-black" />
                                            </div>
                                        </div>
                                        <div className="min-w-0">
                                            <p className="text-sm font-medium text-black truncate max-w-[150px]">
                                                {order.descripcion}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {new Date(order.fechaInicial).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
                                            </p>
                                        </div>
                                    </div>
                                    <span className={`px-3 py-1 rounded-sm text-[10px] font-medium uppercase tracking-wide ${getStatusStyle(order.estado)}`}>
                                        {getStatusText(order.estado)}
                                    </span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                <div className="p-4 bg-white border-t border-gray-100 flex justify-center">
                    <button 
                        onClick={() => { onClose(); onNavigateToFullHistory(); }}
                        className="bg-red-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors text-sm"
                    >
                        Ver m√°s historial
                    </button>
                </div>
            </div>
        );
    }


// --- VERSI√ìN GRATUITA CORREGIDA ---
    function MapComponent({ onLocationSelect, mapId, routeStart, routeEnd }) {
      const mapRef = useRef(null);
      const startMarkerRef = useRef(null);
      const endMarkerRef = useRef(null);
      const routingControlRef = useRef(null);
      const polylineFallbackRef = useRef(null); // L√≠nea de respaldo
      const onSelectRef = useRef(onLocationSelect);

      // Iconos
      const iconBlue = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
      const iconGreen = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

      useEffect(() => { onSelectRef.current = onLocationSelect; }, [onLocationSelect]);

      // 1. INICIALIZAR EL MAPA (OpenStreetMap - GRATIS)
      useEffect(() => {
        if (mapRef.current) return;
        const containerId = mapId || "default-map";
        if (!document.getElementById(containerId)) return;

        const ESPOL_COORDS = [-2.1467, -79.9654];
        const map = L.map(containerId).setView(ESPOL_COORDS, 16);
        mapRef.current = map;

        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            attribution: '¬© Google Maps'
        }).addTo(map);
        
        map.on("click", function(e) {
            const { lat, lng } = e.latlng;
            if (onSelectRef.current) {
                onSelectRef.current(`Ubicaci√≥n: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
            }
        });

        return () => { if (mapRef.current) { mapRef.current.remove(); mapRef.current = null; } };
      }, [mapId]);

      // 2. MARCADORES
      useEffect(() => {
        const map = mapRef.current;
        if (!map) return;

        if (routeStart) {
            if (startMarkerRef.current) startMarkerRef.current.setLatLng([routeStart.lat, routeStart.lng]);
            else startMarkerRef.current = L.marker([routeStart.lat, routeStart.lng], { icon: iconBlue }).addTo(map).bindPopup("Recogida");
            if (!routeEnd) map.panTo([routeStart.lat, routeStart.lng]);
        } else if (startMarkerRef.current) {
            startMarkerRef.current.remove(); startMarkerRef.current = null;
        }

        if (routeEnd) {
            if (endMarkerRef.current) endMarkerRef.current.setLatLng([routeEnd.lat, routeEnd.lng]);
            else endMarkerRef.current = L.marker([routeEnd.lat, routeEnd.lng], { icon: iconGreen }).addTo(map).bindPopup("Entrega");
        } else if (endMarkerRef.current) {
            endMarkerRef.current.remove(); endMarkerRef.current = null;
        }
      }, [routeStart, routeEnd]);

      // 3. RUTA + L√çNEA DE RESPALDO (Sin Token)
      useEffect(() => {
          const map = mapRef.current;
          if (!map) return;

          if (routingControlRef.current) { try { map.removeControl(routingControlRef.current); } catch(e){} routingControlRef.current = null; }
          if (polylineFallbackRef.current) { map.removeLayer(polylineFallbackRef.current); polylineFallbackRef.current = null; }

          if (routeStart && routeEnd) {
              const p1 = L.latLng(routeStart.lat, routeStart.lng);
              const p2 = L.latLng(routeEnd.lat, routeEnd.lng);

              // A. L√≠nea Punteada (Garant√≠a visual)
              polylineFallbackRef.current = L.polyline([p1, p2], {
                  color: 'black', dashArray: '5, 10', weight: 3, opacity: 0.6
              }).addTo(map);

              // B. Zoom Autom√°tico
              map.fitBounds(L.latLngBounds([p1, p2]), { padding: [50, 50] });

              // C. Intento de Ruta real (Servidor Gratis OSRM)
              try {
                  routingControlRef.current = L.Routing.control({
                      waypoints: [p1, p2],
                      lineOptions: { styles: [{ color: 'black', opacity: 0.8, weight: 6 }] },
                      show: false, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: false, createMarker: () => null 
                  }).addTo(map);
              } catch (e) { console.error("Error ruta:", e); }
          }
      }, [routeStart, routeEnd]);

      return <div id={mapId || "default-map"} className="w-full h-full z-0"></div>;
    }

      function SendReceiveView({ onGoBack, onNavigateToFastPrints, onNavigateToBuyTake }) {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [fecha, setFecha] = useState("");
      const [recogida, setRecogida] = useState("");
      const [entrega, setEntrega] = useState("");
      const [hora, setHora] = useState("");
      const [descripcion, setDescripcion] = useState("");
      const [whatsapp, setWhatsapp] = useState("");
      const [activeField, setActiveField] = useState("recogida");
      
      // ESTADOS NUEVOS PARA PRECIO
      const [precioEstimado, setPrecioEstimado] = useState(0);
      const [distanciaKm, setDistanciaKm] = useState(0);
      const isFormValid = fecha && recogida && entrega && hora && descripcion && whatsapp;
      const handleMapSelection = (coordTexto) => {
          if (activeField === "recogida") setRecogida(coordTexto);
          else setEntrega(coordTexto);
      };

// A. NUEVO C√ÅLCULO DE PRECIO (Conecta con Backend)
      useEffect(() => {
          const calcular = async () => {
              const coord1 = parseCoordinates(recogida);
              const coord2 = parseCoordinates(entrega);
              
              let dist = 1.0; 
              if (coord1 && coord2) {
                  dist = getDistanceFromLatLonInKm(coord1.lat, coord1.lng, coord2.lat, coord2.lng);
              }
              setDistanciaKm(dist);

              try {
                  const data = await apiCall(`/pedido/precio_dinamico/?distancia=${dist}&tipo=normal`);
                  setPrecioEstimado(data.precio);
              } catch (e) {
                  console.error("Error calculando precio:", e);
                  // ‚úÖ FALLBACK: Calcular localmente si el backend falla
                  const TARIFA_BASE = 0.50;
                  const COSTO_POR_KM = 0.40;
                  const precioLocal = TARIFA_BASE + (dist * COSTO_POR_KM);
                  setPrecioEstimado(precioLocal);
              }
          };
          
          const timer = setTimeout(calcular, 500);
          return () => clearTimeout(timer);

      }, [recogida, entrega]);

      // B. NUEVO ENV√çO DE PEDIDO (Sin simulaciones falsas)
      const handleSubmit = async () => {
           try {
              if (!localStorage.getItem("accessToken")) { alert("Debes iniciar sesi√≥n."); return; }
              
              await apiCall("/pedido/crear/", "POST", { 
                  num_whats: whatsapp, 
                  descripcion: `${descripcion} (De: ${recogida} -> A: ${entrega})`, 
                  punto_origen: recogida,  // OJO: Usamos los campos de texto nuevos
                  punto_destino: entrega, 
                  horaDeseada: new Date().toISOString(), // O la hora real del input
                  costoEnvio: parseFloat(precioEstimado.toFixed(2)),
                  estado: "Publicado" 
              });
              
              alert("‚úÖ Pedido publicado. Esperando repartidor..."); 
              onGoBack(); // Volver al inicio real

          } catch (error) { alert("Error: " + error.message); }
      };

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="w-full max-w-6xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
              <div className="flex gap-2">
                  <button className="px-5 py-2 bg-black text-white rounded-full font-medium text-sm">Enviar/Recoger</button>
                  <button onClick={onNavigateToFastPrints} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Impresiones r√°pidas</button>
                  <button onClick={onNavigateToBuyTake} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Comprar/LLevar</button>
              </div>
              <div className="w-10 h-10"></div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-white rounded-2xl shadow-lg p-6 sm:p-8 space-y-4">
                <h2 className="text-3xl font-bold text-gray-800 mb-4">Informaci√≥n</h2>
                <input type="text" placeholder="Fecha" onFocus={(e) => (e.target.type = "date")} onBlur={(e) => (e.target.type = "text")} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={fecha} onChange={(e) => setFecha(e.target.value)} />
                
                <div className={`transition-all rounded-lg ${activeField === "recogida" ? "ring-2 ring-blue-500" : ""}`}>
                    <input type="text" placeholder="üìç Punto de Recogida (Toca aqu√≠)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={recogida} onChange={(e) => setRecogida(e.target.value)} onFocus={() => setActiveField("recogida")} />
                </div>
                
                <div className={`transition-all rounded-lg ${activeField === "entrega" ? "ring-2 ring-green-500" : ""}`}>
                    <input type="text" placeholder="üèÅ Punto de Entrega (Toca aqu√≠)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={entrega} onChange={(e) => setEntrega(e.target.value)} onFocus={() => setActiveField("entrega")} />
                </div>

                <input type="text" placeholder="Hora de Entrega" onFocus={(e) => (e.target.type = "time")} onBlur={(e) => (e.target.type = "text")} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={hora} onChange={(e) => setHora(e.target.value)} />
                <textarea placeholder="Descripci√≥n ¬øQu√© se transporta?" rows="4" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={descripcion} onChange={(e) => setDescripcion(e.target.value)}></textarea>
                <input type="tel" placeholder="Numero de Whatsapp" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none focus:ring-2 focus:ring-black" value={whatsapp} onChange={(e) => setWhatsapp(e.target.value)} />
                
                {/* --- VISUALIZACI√ìN DE PRECIO EN VIVO --- */}
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 flex justify-between items-center mt-4 animate-in fade-in">
                    <div>
                        <p className="text-xs text-gray-500 font-bold uppercase">Costo Estimado</p>
                        <p className="text-xs text-gray-400 mt-1">
                           {distanciaKm > 0 ? `Distancia: ${distanciaKm.toFixed(2)} km` : "Define origen y destino"}
                        </p>
                    </div>
                    <div className="text-right">
                        <span className="text-3xl font-black text-black">${precioEstimado.toFixed(2)}</span>
                    </div>
                </div>

                <button onClick={() => setIsModalOpen(true)} disabled={!isFormValid} className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors mt-2 disabled:bg-gray-200 disabled:text-gray-500">Confirmar</button>
              </div>
              
              <div className={`bg-white rounded-2xl shadow-lg overflow-hidden relative min-h-[400px] border-4 transition-colors ${activeField === "recogida" ? "border-blue-100" : "border-green-100"}`}>
                <MapComponent 
                onLocationSelect={handleMapSelection} 
                mapId="mapa-envios" 
                routeStart={parseCoordinates(recogida)} 
                routeEnd={parseCoordinates(entrega)} 
                />
                 <div className={`absolute bottom-4 right-4 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs font-bold z-[400] border ${activeField === "recogida" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-green-50 text-green-700 border-green-200"}`}>
                    {activeField === "recogida" ? "üìç Seleccionando: RECOGIDA" : "üèÅ Seleccionando: ENTREGA"}
                 </div>
              </div>
            </div>
          </div>
          {isModalOpen && <ConfirmacionModal onClose={() => setIsModalOpen(false)} servicio="Enviar/Recoger" desde={recogida} hasta={entrega} hora={hora} onConfirmAction={handleSubmit} costoBase={precioEstimado} />}
        </div>
      );
    }

function FastPrintsView({ onGoBack, onNavigateToSendReceive, onNavigateToBuyTake }) {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [fecha, setFecha] = useState("");
      const [recogida, setRecogida] = useState("");
      const [entrega, setEntrega] = useState("");
      const [hora, setHora] = useState("");
      const [activeField, setActiveField] = useState("recogida"); 
      // Estados para Impresi√≥n
      const [copies, setCopies] = useState("1");
      const [color, setColor] = useState("Color");
      const [fileName, setFileName] = useState(null);
      const fileInputRef = useRef(null);
      const [openDropdown, setOpenDropdown] = useState(null);

      // Estados para Cotizaci√≥n
      const [distanciaKm, setDistanciaKm] = useState(0);
      const [costoEnvio, setCostoEnvio] = useState(0);
      const [totalPagar, setTotalPagar] = useState(0);
      
      // --- C√ÅLCULO EN TIEMPO REAL ---
// --- C√ÅLCULO EN TIEMPO REAL ---
      useEffect(() => {
          const calcularPrecio = async () => {
              // 1. Calcular Distancia
              const coord1 = parseCoordinates(recogida);
              const coord2 = parseCoordinates(entrega);
              let dist = 0;
              if (coord1 && coord2) {
                  dist = getDistanceFromLatLonInKm(coord1.lat, coord1.lng, coord2.lat, coord2.lng);
              } else if (recogida && entrega) {
                  dist = 1.0;
              }
              setDistanciaKm(dist);

              // 2. Calcular Precio de Env√≠o (usar backend)
              let precioEnvio = 0;
              try {
                  const data = await apiCall(`/pedido/precio_dinamico/?distancia=${dist}&tipo=normal`);
                  precioEnvio = data.precio;
              } catch (e) {
                  console.error("Error calculando precio env√≠o:", e);
                  // Fallback local
                  precioEnvio = 0.50 + (dist * 0.40);
              }
              
              // 3. Calcular Precio de Impresi√≥n
              const precioCopia = color === "Color" ? 0.25 : 0.10;
              const totalImpresion = parseInt(copies || 0) * precioCopia;

              setCostoEnvio(precioEnvio);
              setTotalPagar(precioEnvio + totalImpresion);
          };

          const timer = setTimeout(calcularPrecio, 500);
          return () => clearTimeout(timer);

      }, [recogida, entrega, copies, color]);

      const isInfoValid = fecha && recogida && entrega && hora && fileName;
      
      const handleUploadClick = () => fileInputRef.current.click();
      const handleFileSelect = (event) => { if(event.target.files[0]) setFileName(event.target.files[0].name); };
      const toggleDropdown = (name) => setOpenDropdown(openDropdown === name ? null : name);
      const handleSelect = (setter) => (val) => { setter(val); setOpenDropdown(null); };
      const handleMapSelection = (coordTexto) => { if (activeField === "recogida") setRecogida(coordTexto); else setEntrega(coordTexto); };

      const handleSubmitPrint = async () => {
          try {
              if (!localStorage.getItem("accessToken")) { alert("Debes iniciar sesi√≥n."); return; }
              const descripcion = `IMPRESI√ìN: ${fileName} (${copies} copias, ${color}) \nRECOGER: ${recogida} \nENTREGAR: ${entrega}`;
              
              await apiCall("/pedido/crear/", "POST", { 
                num_whats: "0999999999",  // Podr√≠as agregar un campo para esto
                descripcion, 
                punto_origen: recogida,    // ‚úÖ CORREGIDO
                punto_destino: entrega,    // ‚úÖ CORREGIDO
                horaDeseada: new Date().toISOString(), 
                costoEnvio: totalPagar.toFixed(2), 
                estado: "Publicado"
              });
              alert("‚úÖ Orden de impresi√≥n enviada."); onGoBack();
          } catch (error) { alert("Error: " + error.message); }
      };

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="w-full max-w-6xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
              <div className="flex gap-2">
                  <button onClick={onNavigateToSendReceive} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Enviar/Recoger</button>
                  <button className="px-5 py-2 bg-black text-white rounded-full font-medium text-sm">Impresiones r√°pidas</button>
                  <button onClick={onNavigateToBuyTake} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300 transition-colors">Comprar/LLevar</button>
              </div>
              <div className="w-10 h-10"></div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="flex flex-col gap-6">
                <div className="bg-white rounded-2xl shadow-lg p-6">
                  <h2 className="text-3xl font-bold text-gray-800 mb-6">Detalles del Pedido</h2>
                  <div className="space-y-4">
                    <input type="text" placeholder="Fecha" onFocus={(e)=>e.target.type="date"} onBlur={(e)=>e.target.type="text"} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={fecha} onChange={(e)=>setFecha(e.target.value)}/>
                    
                    <div className={`transition-all rounded-lg ${activeField === "recogida" ? "ring-2 ring-blue-500" : ""}`}>
                        <input type="text" placeholder="üìç ¬øD√≥nde se imprime? (Papeler√≠a)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={recogida} onChange={(e)=>setRecogida(e.target.value)} onFocus={() => setActiveField("recogida")} />
                    </div>
                    
                    <div className={`transition-all rounded-lg ${activeField === "entrega" ? "ring-2 ring-green-500" : ""}`}>
                        <input type="text" placeholder="üèÅ ¬øD√≥nde te lo llevan? (Tu ubicaci√≥n)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={entrega} onChange={(e)=>setEntrega(e.target.value)} onFocus={() => setActiveField("entrega")} />
                    </div>
                    
                    <input type="text" placeholder="Hora de Entrega Deseada" onFocus={(e)=>e.target.type="time"} onBlur={(e)=>e.target.type="text"} className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={hora} onChange={(e)=>setHora(e.target.value)}/>
                  </div>
                </div>

                <div className="bg-white rounded-2xl shadow-lg p-6">
                  <h3 className="text-xl font-semibold text-gray-800 mb-4">Configuraci√≥n de Archivo</h3>
                  <div className="space-y-4">
                    <input type="file" ref={fileInputRef} onChange={handleFileSelect} style={{ display: "none" }} accept=".pdf,.doc,.docx" />
                    <button onClick={handleUploadClick} className="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 border border-dashed border-gray-300">{fileName ? `üìÑ ${fileName}` : "Subir Archivo (.pdf, .docx)"}</button>
                    
                    <div className="flex gap-4">
                        <div className="relative w-1/2">
                            <button onClick={()=>toggleDropdown("color")} className="w-full flex justify-between items-center px-4 py-3 bg-gray-100 rounded-lg"><span>{color}</span><ChevronDown/></button>
                            {openDropdown === "color" && <DropdownMenu options={["Color", "Blanco y Negro"]} onSelect={handleSelect(setColor)}/>}
                        </div>
                        <input type="number" min="1" value={copies} onChange={(e)=>setCopies(e.target.value)} className="w-1/2 px-4 py-3 bg-gray-100 rounded-lg text-center" placeholder="Copias"/>
                    </div>

                    {/* --- COTIZACI√ìN EN VIVO --- */}
                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 flex justify-between items-center mt-2 animate-in fade-in">
                        <div>
                            <p className="text-xs text-gray-500 font-bold uppercase">Total Estimado</p>
                            <p className="text-xs text-gray-400 mt-1">Env√≠o: ${costoEnvio.toFixed(2)} + Impresi√≥n</p>
                        </div>
                        <div className="text-right">
                            <span className="text-3xl font-black text-black">${totalPagar.toFixed(2)}</span>
                        </div>
                    </div>

                    <button onClick={() => setIsModalOpen(true)} disabled={!isInfoValid} className={`w-full py-3 rounded-lg font-medium text-white transition-colors mt-2 ${isInfoValid ? "bg-black hover:bg-gray-800" : "bg-gray-200 text-gray-500 cursor-not-allowed"}`}>Confirmar Pedido</button>
                  </div>
                </div>
              </div>

              <div className="flex flex-col gap-6 h-full">
                <div className={`bg-white rounded-2xl shadow-lg overflow-hidden relative h-full min-h-[400px] border-4 transition-colors ${activeField === "recogida" ? "border-blue-100" : "border-green-100"}`}>
                   {/* AQU√ç CONECTAMOS EL MAPA CON LAS COORDENADAS */}
                   <MapComponent 
                        onLocationSelect={handleMapSelection} 
                        mapId="mapa-impresiones" 
                        routeStart={parseCoordinates(recogida)} 
                        routeEnd={parseCoordinates(entrega)} 
                   />
                   <div className={`absolute bottom-4 right-4 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs font-bold z-[400] pointer-events-none border transition-colors ${activeField === "recogida" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-green-50 text-green-700 border-green-200"}`}>
                       {activeField === "recogida" ? "üìç Seleccionando: D√≥nde IMPRIMIR" : "üèÅ Seleccionando: D√≥nde ENTREGAR"}
                   </div>
                </div>
              </div>
            </div> 
          </div>
          {isModalOpen && <ConfirmacionModal onClose={() => setIsModalOpen(false)} servicio="Impresiones R√°pidas" desde={recogida} hasta={entrega} hora={hora} onConfirmAction={handleSubmitPrint} costoBase={totalPagar} />}
        </div>
      );
    }

 function BuyTakeView({ onGoBack, onNavigateToSendReceive, onNavigateToFastPrints }) {
      const [storeName, setStoreName] = useState("");
      const [storeAddress, setStoreAddress] = useState("");
      const [deliveryPoint, setDeliveryPoint] = useState("");
      const [whatsapp, setWhatsapp] = useState("");
      const [activeField, setActiveField] = useState("store"); 
      const [items, setItems] = useState([]); 
      const [nextId, setNextId] = useState(1);
      const [isModalOpen, setIsModalOpen] = useState(false);
      
      // Estados Cotizaci√≥n
      const [distanciaKm, setDistanciaKm] = useState(0);
      const [costoEnvio, setCostoEnvio] = useState(0);
      const [totalFinal, setTotalFinal] = useState(0);

      // Total solo de productos (Suma de la lista)
      const totalProductos = items.reduce((sum, item) => sum + ((parseFloat(item.cost) || 0) * (parseInt(item.quantity) || 1)), 0);

      // --- C√ÅLCULO EN TIEMPO REAL ---
      useEffect(() => {
          const calcularPrecio = async () => {
              // 1. Calcular Distancia
              const coord1 = parseCoordinates(storeAddress);
              const coord2 = parseCoordinates(deliveryPoint);
              let dist = 0;
              if (coord1 && coord2) {
                  dist = getDistanceFromLatLonInKm(coord1.lat, coord1.lng, coord2.lat, coord2.lng);
              } else if (storeAddress && deliveryPoint) {
                  dist = 1.0; 
              }
              setDistanciaKm(dist);

              // 2. Calcular Env√≠o (usar backend con tipo "pesado")
              let tarifaEnvio = 0;
              try {
                  const data = await apiCall(`/pedido/precio_dinamico/?distancia=${dist}&tipo=pesado`);
                  tarifaEnvio = data.precio;
              } catch (e) {
                  console.error("Error calculando precio env√≠o:", e);
                  // Fallback: Base m√°s alta para compras
                  tarifaEnvio = 0.75 + (dist * 0.30);
              }
              
              setCostoEnvio(tarifaEnvio);
              setTotalFinal(totalProductos + tarifaEnvio);
          };

          const timer = setTimeout(calcularPrecio, 500);
          return () => clearTimeout(timer);

      }, [storeAddress, deliveryPoint, totalProductos]);

      const isInfoValid = storeName && storeAddress && deliveryPoint && whatsapp;
      const areItemsValid = items.length > 0 && items.every(i => i.description && i.quantity > 0);

      const handleMapSelection = (coordTexto) => { if (activeField === "store") setStoreAddress(coordTexto); else setDeliveryPoint(coordTexto); };
      const handleAddItem = () => { setItems([...items, { id: nextId, description: "", quantity: 1, cost: "" }]); setNextId(nextId + 1); };
      const handleDeleteItem = (id) => setItems(items.filter(i => i.id !== id));
      const handleItemChange = (id, field, value) => { setItems(curr => curr.map(i => i.id === id ? { ...i, [field]: value } : i)); };
      
      const handleSubmitBuy = async () => {
          try {
              if (!localStorage.getItem("accessToken")) { alert("Inicia sesi√≥n primero."); return; }
              const listaTexto = items.map(i => `- ${i.quantity}x ${i.description} (Est: $${i.cost || "?"})`).join("\n");
              const descripcion = `COMPRAR: ${storeName} (${storeAddress}) -> Entregar: ${deliveryPoint}\nLISTA:\n${listaTexto}`;
              
              await apiCall("/pedido/crear/", "POST", { 
                  num_whats: whatsapp, 
                  descripcion, 
                  punto_origen: storeAddress,   // ‚úÖ Direcci√≥n de la tienda
                  punto_destino: deliveryPoint, // ‚úÖ Punto de entrega
                  horaDeseada: new Date().toISOString(),
                  costoEnvio: totalFinal.toFixed(2),
                  estado: "Publicado" 
              });
              alert("‚úÖ Pedido de compra creado."); onGoBack();
          } catch (e) { alert("Error: " + e.message); }
      };

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="w-full max-w-4xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full"><ArrowLeft /></button>
              <div className="flex gap-2">
                  <button onClick={onNavigateToSendReceive} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300">Enviar/Recoger</button>
                  <button onClick={onNavigateToFastPrints} className="px-5 py-2 bg-gray-200 text-gray-800 rounded-full font-medium text-sm hover:bg-gray-300">Impresiones r√°pidas</button>
                  <button className="px-5 py-2 bg-black text-white rounded-full font-medium text-sm">Comprar/Llevar</button>
              </div>
              <div className="w-10 h-10"></div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
              <div className="bg-white rounded-2xl shadow-lg p-6 space-y-4 h-full">
                <h2 className="text-3xl font-bold text-gray-800 mb-4">Informaci√≥n</h2>
                <input type="text" placeholder="Nombre de la Tienda (Ej: Comedor Ficticio)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={storeName} onChange={e=>setStoreName(e.target.value)}/>
                
                <div className={`transition-all rounded-lg ${activeField === "store" ? "ring-2 ring-blue-500" : ""}`}>
                    <input type="text" placeholder="üìç Direcci√≥n Tienda (Toca para mapa)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={storeAddress} onChange={e=>setStoreAddress(e.target.value)} onFocus={() => setActiveField("store")} />
                </div>
                
                <div className={`transition-all rounded-lg ${activeField === "delivery" ? "ring-2 ring-green-500" : ""}`}>
                    <input type="text" placeholder="üèÅ Punto de Entrega (Toca para mapa)" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none border border-transparent focus:bg-white" value={deliveryPoint} onChange={e=>setDeliveryPoint(e.target.value)} onFocus={() => setActiveField("delivery")} />
                </div>
                
                <input type="tel" placeholder="Tu Whatsapp" className="w-full px-4 py-3 bg-gray-100 rounded-lg outline-none" value={whatsapp} onChange={e=>setWhatsapp(e.target.value)}/>
              </div>

              <div className={`bg-white rounded-2xl shadow-lg overflow-hidden relative min-h-[400px] border-4 transition-colors ${activeField === "store" ? "border-blue-100" : "border-green-100"}`}>
                 {/* MAPA CONECTADO */}
                 <MapComponent 
                    onLocationSelect={handleMapSelection} 
                    mapId="mapa-compras" 
                    routeStart={parseCoordinates(storeAddress)} 
                    routeEnd={parseCoordinates(deliveryPoint)}
                 />
                 <div className={`absolute bottom-4 right-4 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs font-bold z-[400] pointer-events-none border transition-colors ${activeField === "store" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-green-50 text-green-700 border-green-200"}`}>
                     {activeField === "store" ? "üìç Seleccionando: TIENDA" : "üèÅ Seleccionando: ENTREGA"}
                 </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6 space-y-4">
              <h2 className="text-3xl font-bold text-gray-800 mb-4">Lista de Compras</h2>
              {items.map(item => (
                  <div key={item.id} className="flex gap-2 items-center">
                      <input className="w-full p-3 bg-gray-100 rounded" placeholder="Producto (Ej: Cola, Sanduche)" value={item.description} onChange={e=>handleItemChange(item.id, "description", e.target.value)}/>
                      <input type="number" className="w-20 p-3 bg-gray-100 rounded text-center" placeholder="#" value={item.quantity} onChange={e=>handleItemChange(item.id, "quantity", e.target.value)}/>
                      <input type="number" className="w-24 p-3 bg-gray-100 rounded text-center" placeholder="$ Est." value={item.cost} onChange={e=>handleItemChange(item.id, "cost", e.target.value)}/>
                      <button onClick={()=>handleDeleteItem(item.id)} className="p-2 text-red-500"><Trash/></button>
                  </div>
              ))}
              <button onClick={handleAddItem} className="flex items-center gap-2 px-4 py-2 border-2 border-dashed rounded text-gray-600 hover:bg-gray-50"><Plus className="w-4 h-4"/> A√±adir Producto</button>
              
              {/* --- TOTALES EN VIVO --- */}
              <div className="border-t border-gray-100 mt-4 pt-4 flex justify-end">
                  <div className="text-right">
                      <p className="text-sm text-gray-500">Productos: ${totalProductos.toFixed(2)}</p>
                      <p className="text-sm text-gray-500">Env√≠o ({distanciaKm.toFixed(1)}km): ${costoEnvio.toFixed(2)}</p>
                      <p className="text-2xl font-bold text-black mt-1">Total: ${totalFinal.toFixed(2)}</p>
                  </div>
              </div>
            </div>

            <div className="mt-8 flex justify-end">
                <button onClick={() => setIsModalOpen(true)} disabled={!isInfoValid || !areItemsValid} className={`px-8 py-3 rounded-lg font-medium text-white ${isInfoValid && areItemsValid ? "bg-black hover:bg-gray-800" : "bg-gray-300 cursor-not-allowed"}`}>Confirmar y Pagar</button>
            </div>
          </div>
          {isModalOpen && <ConfirmacionModal onClose={() => setIsModalOpen(false)} servicio="Comprar/Llevar" desde={storeName} hasta={deliveryPoint} hora="N/A" costoBase={totalFinal} onConfirmAction={handleSubmitBuy} />}
        </div>
      );
    }
    
    function NewFavorView({ onGoBack, onNavigateToSendReceive, onNavigateToFastPrints, onNavigateToBuyTake }) {
      return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl mx-auto">
            <div className="flex items-center p-6 pb-4">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors mr-4"><ArrowLeft /></button>
              <h2 className="text-4xl font-bold text-gray-800">Programa tu Mandado</h2>
            </div>
            <div className="px-6 pb-6">
              <div className="mt-4">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Categor√≠a de Servicios</h3>
                <div className="flex flex-col gap-4">
                  <div onClick={onNavigateToFastPrints} className="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <div className="flex justify-between items-center"><h4 className="font-bold text-sm">IMPRESIONES R√ÅPIDAS</h4><ChevronUp /></div>
                    <p className="text-sm text-gray-600 mt-2">Sube archivos digitales y recoge el pedido listo en el punto designado.</p>
                  </div>
                  <div onClick={onNavigateToSendReceive} className="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <h4 className="font-bold text-sm">ENVIAR/RECOGER</h4>
                    <p className="text-sm text-gray-600 mt-2">Servicio de mensajer√≠a interna r√°pido para trasladar objetos entre dos puntos del campus.</p>
                  </div>
                  <div onClick={onNavigateToBuyTake} className="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <h4 className="font-bold text-sm">COMPRAR/LLEVAR</h4>
                    <p className="text-sm text-gray-600 mt-2">Pide art√≠culos de tiendas fuera del campus y rec√≠belos sin salir.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function DriverRegisterView({ onGoBack, onNavigateToWelcome, onSignIn, onRegister }) {
      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex items-center justify-between h-16">
                <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
                <div className="flex items-center gap-3">
                  <button onClick={onSignIn} className="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Sign in</button>
                  <button onClick={onRegister} className="px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg transition-colors">Register</button>
                  <div className="w-px h-8 bg-gray-300 mx-2" />
                  <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative"><ShoppingCart /></button>
                </div>
              </div>
            </div>
          </header>
          <main className="max-w-7xl mx-auto py-0">
            <div className="bg-black text-white p-8 md:p-16 rounded-b-2xl shadow-xl overflow-hidden relative">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div className="relative z-10 space-y-4 max-w-lg">
                  <h1 className="text-4xl md:text-5xl font-bold leading-tight">Haz entregas en tu universidad.</h1>
                  <p className="text-gray-300 text-lg">Reg√≠strate en nuestra plataforma y empieza a hacer env√≠os en tu universidad.</p>
                  <button onClick={onNavigateToWelcome} className="px-6 py-3 bg-white text-black rounded-lg font-semibold hover:bg-gray-200 transition-colors shadow-lg mt-6">Reg√≠strate para hacer entregas</button>
                </div>
                <div className="hidden md:block absolute right-0 top-0 h-full w-1/2 p-8 pt-16 lg:p-16">
                   <div className="absolute inset-0">
                        <svg viewBox="0 0 100 100" className="w-full h-full" preserveAspectRatio="xMidYMid meet">
                            <rect x="62" y="10" width="18" height="3" fill="#B30000" rx="1.5"/><rect x="65" y="13" width="12" height="5" fill="#B30000" rx="1"/><circle cx="71" cy="22" r="5" fill="#F0C088" />
                            <path d="M68 30 L64 50 L68 50 L72 30 Z" fill="#FFFFFF" stroke="#000000" strokeWidth="1"/><path d="M74 30 L78 50 L74 50 L70 30 Z" fill="#FFFFFF" stroke="#000000" strokeWidth="1"/>
                            <path d="M65 55 L63 80 L67 80 L69 55 Z" fill="#6A6A6A"/><path d="M77 55 L75 80 L79 80 L81 55 Z" fill="#6A6A6A"/>
                            <rect x="58" y="38" width="26" height="20" fill="#E48E44" stroke="#000000" strokeWidth="1"/><line x1="58" y1="48" x2="84" y2="48" stroke="#000000" strokeWidth="1"/><line x1="71" y1="38" x2="71" y2="58" stroke="#000000" strokeWidth="1"/>
                        </svg>
                </div>
                </div>
              </div>
            </div>
            <div className="px-4 sm:px-6 lg:px-8 py-12 md:py-16">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                <div>
                  <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Walk className="w-6 h-6 text-black" />Descubre lo que necesitas para empezar a trabajar.</h3>
                  <ul className="text-gray-600 space-y-2"><li className="flex items-center gap-2"><Check className="w-4 h-4 text-green-500" /> C√©dula de identidad o carnet estudiantil.</li><li className="flex items-center gap-2"><Check className="w-4 h-4 text-green-500" /> Tiempo libre</li></ul>
                </div>
                <div className="md:col-span-1">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">En 3 simples pasos</h3>
                  <ol className="text-gray-600 space-y-2 list-none p-0"><li className="font-semibold text-black">1. Reg√≠strate</li><li>2. Recoge y entrega</li><li>3. Gana dinero</li></ol>
                </div>
              </div>
            </div>
          </main>
        </div>
      );
    }
    
    //------funcion temporal para manejar datos del repartidor mientras se registra
    function DriverBasicDataView({ data, onSave, onGoBack }) {
      // Usamos estado local para el formulario, inicializado con los datos que ya existan
      const [formData, setFormData] = useState({
        nombre: data.nombre || "",
        apellido: data.apellido || "",
        correo: data.correo || "",
        contrasena: data.contrasena || ""
      });

      const isFormValid = formData.nombre && formData.apellido && formData.correo && formData.contrasena;

      const handleSave = () => {
        onSave(formData); // Guardamos en el estado padre
        onGoBack(); // Volvemos al men√∫
      };

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in slide-in-from-right">
           <header className="max-w-xl mx-auto mb-8 flex items-center">
             <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors mr-4"><ArrowLeft /></button>
             <h2 className="text-2xl font-bold">Datos B√°sicos</h2>
           </header>
           <main className="max-w-xl mx-auto space-y-4">
             <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
               <input type="text" className="w-full p-3 border rounded-lg bg-gray-50" value={formData.nombre} onChange={e => setFormData({...formData, nombre: e.target.value})} placeholder="Ej. Juan" />
             </div>
             <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
               <input type="text" className="w-full p-3 border rounded-lg bg-gray-50" value={formData.apellido} onChange={e => setFormData({...formData, apellido: e.target.value})} placeholder="Ej. P√©rez" />
             </div>
             <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Correo Institucional</label>
               <input type="email" className="w-full p-3 border rounded-lg bg-gray-50" value={formData.correo} onChange={e => setFormData({...formData, correo: e.target.value})} placeholder="juan@espol.edu.ec" />
             </div>
             <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
               <input type="password" className="w-full p-3 border rounded-lg bg-gray-50" value={formData.contrasena} onChange={e => setFormData({...formData, contrasena: e.target.value})} placeholder="********" />
             </div>
             
             <button 
               onClick={handleSave} 
               disabled={!isFormValid}
               className="w-full bg-black text-white py-4 rounded-lg font-bold hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed mt-8 transition-colors"
             >
               Guardar Datos
             </button>
           </main>
        </div>
      );
    }

    //------------------


    //Funcion de pestania de registro actualizada
    function DriverWelcomeView({ onGoBack, onNavigateToBasicData, onNavigateToProfilePhoto, onNavigateToCarnetPhoto, regData, onFinalRegister }) { 
      // Verificamos qu√© pasos est√°n completos
      const steps = {
        basic: regData.nombre && regData.apellido && regData.correo && regData.contrasena,
        profile: !!regData.fotoPerfilFile, // Verificamos si existe el archivo
        carnet: !!regData.fotoCarnetFile   // Verificamos si existe el archivo
      };
      
      const allComplete = steps.basic && steps.profile && steps.carnet;
      const [loading, setLoading] = useState(false);

      const handleRegisterClick = async () => {
         setLoading(true);
         try {
            await onFinalRegister();
         } catch(e) {
            console.error(e);
            setLoading(false);
         }
      };

      // Icono de Check verde o Chevron
      const StatusIcon = ({ isDone }) => isDone 
        ? <div className="bg-green-100 p-1 rounded-full"><Check className="w-5 h-5 text-green-600" /></div>
        : <ChevronRight className="text-gray-400" />;

      return (
        <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
          <header className="max-w-4xl mx-auto mb-8">
            <div className="flex items-center justify-between h-16">
                <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
            </div>
          </header>
          <main className="max-w-4xl mx-auto">
            <h1 className="text-4xl sm:text-5xl font-bold text-gray-900 mb-4">
                Te damos la bienvenida{regData.nombre ? `, ${regData.nombre}` : ""}.
            </h1>
            <p className="text-gray-500 mb-12">
                Completa estos pasos para activar tu cuenta de repartidor.
            </p>
            
            <div className="space-y-4">
              {/* PASO 1: DATOS B√ÅSICOS */}
              <button onClick={onNavigateToBasicData} className="w-full flex justify-between items-center p-6 border border-gray-100 rounded-xl shadow-sm hover:shadow-md transition-all group bg-white">
                <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${steps.basic ? 'bg-black text-white' : 'bg-gray-100 text-gray-500'}`}>1</div>
                    <div className="text-left">
                        <span className="block text-lg font-medium text-gray-800">Datos Personales</span>
                        <span className="text-sm text-gray-500">{steps.basic ? `${regData.nombre} ${regData.apellido}` : "Nombre, correo, contrase√±a"}</span>
                    </div>
                </div>
                <StatusIcon isDone={steps.basic} />
              </button>

              {/* PASO 2: FOTO DE PERFIL */}
              <button onClick={onNavigateToProfilePhoto} className="w-full flex justify-between items-center p-6 border border-gray-100 rounded-xl shadow-sm hover:shadow-md transition-all group bg-white">
                <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${steps.profile ? 'bg-black text-white' : 'bg-gray-100 text-gray-500'}`}>2</div>
                    <div className="text-left">
                        <span className="block text-lg font-medium text-gray-800">Foto de Perfil</span>
                        <span className="text-sm text-gray-500">{steps.profile ? "Foto cargada" : "Para que te reconozcan"}</span>
                    </div>
                </div>
                <StatusIcon isDone={steps.profile} />
              </button>

              {/* PASO 3: FOTO CARNET */}
              <button onClick={onNavigateToCarnetPhoto} className="w-full flex justify-between items-center p-6 border border-gray-100 rounded-xl shadow-sm hover:shadow-md transition-all group bg-white">
                <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${steps.carnet ? 'bg-black text-white' : 'bg-gray-100 text-gray-500'}`}>3</div>
                    <div className="text-left">
                        <span className="block text-lg font-medium text-gray-800">Foto del Carnet</span>
                        <span className="text-sm text-gray-500">{steps.carnet ? "Credencial cargada" : "Validaci√≥n de estudiante"}</span>
                    </div>
                </div>
                <StatusIcon isDone={steps.carnet} />
              </button>
            </div>

            <div className="mt-12 border-t pt-8">
                <button 
                    onClick={handleRegisterClick}
                    disabled={!allComplete || loading}
                    className="w-full py-4 rounded-xl font-bold text-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed bg-black text-white shadow-xl hover:bg-gray-900"
                >
                    {loading ? "Subiendo datos..." : "Finalizar Registro"}
                </button>
                {!allComplete && <p className="text-center text-xs text-gray-400 mt-2">Completa los 3 pasos para activar el bot√≥n</p>}
            </div>
          </main>
        </div>
      );
    }

    //----------------

    // Actualizacion de la funcion de subida de foto del carnet
    function CarnetPhotoUploadView({ onGoBack, onSave }) {
      const fileInputRef = useRef(null);
      const [fileName, setFileName] = useState(null);
      
      const handleUploadClick = () => fileInputRef.current.click();
      const handleFileSelect = (event) => { 
          const file = event.target.files[0]; 
          if (file) {
              setFileName(file.name);
              // Autom√°ticamente guardamos y volvemos 
              if(confirm(`¬øUsar ${file.name}?`)) {
                 onSave(file);
              }
          } 
      };
      
      return (
        <div className="min-h-screen bg-pink-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <header className="max-w-xl mx-auto mb-8 flex justify-between items-center">
    <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
    {/* Agregado del Main: */}
    <button className="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black transition-colors">
        <HelpCircle /><span className="text-sm font-medium">Ayuda</span>
    </button>
</header>
          <main className="max-w-xl mx-auto">
            <h1 className="text-4xl sm:text-5xl font-bold text-gray-900 mb-6">Sube foto de credencial.</h1>
            <div className="w-full flex justify-center mb-8"><div className="w-full max-w-sm h-48 bg-gray-300 rounded-xl flex items-center justify-center border-4 border-dashed border-gray-400"><IdCard className="w-40 h-40 text-gray-500" /></div></div>
            <div className="space-y-4">
                <input type="file" ref={fileInputRef} onChange={handleFileSelect} style={{ display: "none" }} accept="image/*" />
                <button onClick={handleUploadClick} className="w-full bg-gray-800 text-white py-4 rounded-lg font-medium hover:bg-black transition-colors">Seleccionar Archivo</button>
            </div>
          </main>
        </div>
      );
    }
    //-----------


    //actualizacion de la funcion de subida de  foto de perfil
    function ProfilePhotoUploadView({ onGoBack, onSave }) {
      const [stream, setStream] = useState(null); 
      const [error, setError] = useState(null); 
      const videoRef = useRef(null); 

      const handleStartCamera = async () => { setError(null); try { const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false }); setStream(s); } catch (err) { console.error(err); setError("No c√°mara."); } };
      
      useEffect(() => { if (stream && videoRef.current) { videoRef.current.srcObject = stream; } return () => { if (stream) { stream.getTracks().forEach(track => track.stop()); } }; }, [stream]); 
      
      const handleCapture = () => {
         if(!videoRef.current) return;
         // Crear canvas para capturar frame
         const canvas = document.createElement("canvas");
         canvas.width = videoRef.current.videoWidth;
         canvas.height = videoRef.current.videoHeight;
         canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
         
         // Convertir a archivo (Blob)
         canvas.toBlob((blob) => {
             const file = new File([blob], "perfil_camara.jpg", { type: "image/jpeg" });
             onSave(file); // Enviamos al padre
         }, 'image/jpeg');
      };

      return (
        <div className="min-h-screen bg-pink-50 p-4 sm:p-8 animate-in fade-in duration-300">
          <header className="max-w-xl mx-auto mb-8 flex justify-between items-center">
              <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>
              {/* Agregado del Main: */}
              <button className="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black transition-colors">
                  <HelpCircle /><span className="text-sm font-medium">Ayuda</span>
              </button>
          </header>
          <main className="max-w-xl mx-auto">
            <h1 className="text-4xl sm:text-5xl font-bold text-gray-900 mb-6">Foto de perfil.</h1>
            <div className="w-full flex justify-center mb-8"><div className="w-56 h-56 bg-gray-300 rounded-full flex items-center justify-center overflow-hidden border-4 border-white shadow-lg">{stream ? (<video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover transform -scale-x-100" />) : (<User className="w-32 h-32 text-gray-500" />)}</div></div>
            {error && (<div className="text-center text-red-600 font-medium mb-4">{error}</div>)}
            <div className="space-y-4">
                {stream ? (
                    <button onClick={handleCapture} className="w-full bg-black text-white py-4 rounded-lg font-bold hover:bg-gray-800 transition-colors">Capturar y Guardar</button>
                ) : (
                    <button onClick={handleStartCamera} className="w-full bg-gray-800 text-white py-4 rounded-lg font-medium hover:bg-black transition-colors">Abrir C√°mara</button>
                )}
            </div>
          </main>
        </div>
      );
    }
    
    // -----------

    function ActiveOrderView({ orderId, userRole, onGoBack }) {
        const [order, setOrder] = useState(null);
        const [otpInput, setOtpInput] = useState("");

        // 1. L√ìGICA DE DATOS (Backend Real)
        useEffect(() => {
            const fetchDetail = async () => { 
                try { 
                    const data = await apiCall(`/pedido/detalle/${orderId}/`); 
                    setOrder(data); 
                } catch (e) { console.error(e); } 
            };
            fetchDetail();
            const interval = setInterval(fetchDetail, 5000); 
            return () => clearInterval(interval);
        }, [orderId]);

        // 2. L√ìGICA DE FINALIZAR (Solo Repartidor)
        const handleComplete = async () => {
            if (!otpInput) return alert("‚ö†Ô∏è Debes ingresar el c√≥digo de 4 d√≠gitos.");
            try {
                await apiCall(`/pedido/finalizar/${orderId}/`, "POST", { otp: otpInput });
                alert("‚úÖ Entrega validada con √©xito.");
                onGoBack(); 
            } catch (e) { alert("‚ùå " + e.message); }
        };

        if (!order) return <div className="min-h-screen flex items-center justify-center font-bold text-xl">Cargando tu pedido...</div>;
        
        const isDriver = userRole === "repartidor";
        const isFinished = order.estado === 'Entregado';

        // 3. DISE√ëO "SPLIT VIEW" (Replicado de tu imagen image_9b70bf.png)
        return (
            <div className="min-h-screen bg-white flex flex-col lg:flex-row font-sans">
                
                {/* --- COLUMNA IZQUIERDA: INFORMACI√ìN Y ESTADOS (35% ancho) --- */}
                <div className="w-full lg:w-[450px] bg-white flex flex-col h-auto lg:h-screen shadow-2xl z-20 relative border-r border-gray-100">
                    
                    {/* Header con Bot√≥n Atr√°s */}
                    <div className="p-6 pb-2 bg-white sticky top-0 z-10">
                        <button onClick={onGoBack} className="flex items-center gap-2 text-gray-500 hover:text-black transition-colors mb-4">
                            <ArrowLeft className="w-5 h-5" /> <span className="font-medium">Volver</span>
                        </button>
                        
                        <h1 className="text-3xl font-black text-gray-900 tracking-tight leading-none mb-2">Seguimiento de pedido</h1>
                        
                        <div className="flex flex-col">
                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Log√≠stica y Estado</span>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="text-gray-400 font-mono text-sm">#{order.codigoPedido}</span>
                                {/* Badge de Estado */}
                                <span className={`px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide border ${isFinished ? 'bg-green-50 text-green-700 border-green-200' : 'bg-black text-white border-black'}`}>
                                    {order.estado}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Contenido Principal */}
                    <div className="flex-1 overflow-y-auto p-6 pt-2 space-y-8">
                        
                        {/* Nombre del Pedido */}
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900">{order.descripcion.split('(')[0] || "Encargo General"}</h2>
                            <p className="text-sm text-gray-400 mt-1">
                                {order.estado === 'Publicado' ? "Esperando asignaci√≥n..." : `Gestionado por: ${isDriver ? order.cliente_nombre : (order.repartidor_nombre || "...")}`}
                            </p>
                        </div>

                        {/* --- TIMELINE VISUAL (Id√©ntico a la imagen) --- */}
                        <div className="relative pl-4 border-l-2 border-gray-100 ml-2 space-y-10 py-2">
                            {/* Punto A: Recogida (C√≠rculo Gris) */}
                            <div className="relative">
                                <div className="absolute -left-[21px] top-1 w-4 h-4 bg-gray-200 rounded-full border-4 border-white ring-1 ring-gray-100"></div>
                                <div>
                                    <p className="text-xs font-bold text-gray-900 uppercase mb-0.5">Punto de Recogida</p>
                                    <p className="text-xs text-gray-500">{new Date(order.fechaInicial).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                    <p className="font-medium text-gray-700 mt-1 text-sm bg-gray-50 p-2 rounded-lg inline-block">
                                        üìç {order.punto_origen}
                                    </p>
                                </div>
                            </div>

                            {/* Punto B: Entrega (C√≠rculo Negro) */}
                            <div className="relative">
                                <div className={`absolute -left-[21px] top-1 w-4 h-4 rounded-full border-4 border-white ring-1 ring-gray-100 ${isFinished ? 'bg-green-500' : 'bg-black'}`}></div>
                                <div>
                                    <p className={`text-xs font-bold uppercase mb-0.5 ${isFinished ? 'text-green-600' : 'text-black'}`}>
                                        {isFinished ? "Entregado" : "Entrega Final"}
                                    </p>
                                    <p className="text-xs text-gray-500">
                                        {order.horaDeseada ? "Estimado: " + new Date(order.horaDeseada).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "Pendiente"}
                                    </p>
                                    <p className="font-medium text-gray-700 mt-1 text-sm bg-gray-50 p-2 rounded-lg inline-block">
                                        üèÅ {order.punto_destino}
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Tarjeta de Contacto (Repartidor/Cliente) */}
                        <div className="bg-gray-50 p-4 rounded-2xl flex items-center gap-4 border border-gray-100 shadow-sm">
                            <div className="w-10 h-10 bg-white border border-gray-200 rounded-full flex items-center justify-center text-lg shadow-sm">
                                üë§
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">{isDriver ? "Cliente" : "Repartidor"}</p>
                                <p className="font-bold text-gray-900 truncate">
                                    {isDriver ? order.cliente_nombre : (order.repartidor_nombre || "Buscando...")}
                                </p>
                            </div>
                            {/* Bot√≥n WhatsApp */}
                            {order.num_whats && (
                                <a href={`https://wa.me/${order.num_whats}`} target="_blank" className="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors shadow-md flex items-center justify-center">
                                    <WhatsApp className="w-5 h-5" />
                                </a>
                            )}
                        </div>

                    </div>

                    {/* --- FOOTER: ACCIONES Y PIN (Sticky Bottom) --- */}
                    <div className="p-6 border-t border-gray-100 bg-white">
                        
                        {/* CASO: Mostrar PIN al Cliente */}
                        {order.estado === 'Aceptado' && !isDriver && (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-center shadow-inner">
                                <p className="text-[10px] font-bold text-yellow-800 uppercase mb-1 tracking-widest">C√≥digo de Seguridad</p>
                                <p className="text-4xl font-mono font-black text-gray-900 tracking-[0.3em]">{order.codigo_entrega}</p>
                                <p className="text-[10px] text-gray-500 mt-1">Dicta este c√≥digo al repartidor para confirmar.</p>
                            </div>
                        )}

                        {/* CASO: Ingresar PIN el Repartidor */}
                        {order.estado === 'Aceptado' && isDriver && (
                            <div className="flex gap-2">
                                <input 
                                    type="tel" maxLength="4" placeholder="PIN" 
                                    className="w-24 text-center text-xl font-mono font-bold p-3 border-2 border-gray-200 rounded-xl focus:border-black outline-none transition-colors bg-gray-50"
                                    value={otpInput} onChange={(e) => setOtpInput(e.target.value)} 
                                />
                                <button 
                                    onClick={handleComplete}
                                    className="flex-1 bg-black text-white font-bold rounded-xl hover:bg-gray-800 transition-transform active:scale-95 shadow-lg"
                                >
                                    Marcar como Entregado
                                </button>
                            </div>
                        )}

                        {/* CASO: Esperando */}
                        {order.estado === 'Publicado' && (
                            <div className="text-center py-3 bg-gray-50 rounded-xl border border-gray-100 text-gray-400 text-sm animate-pulse">
                                üì° Buscando repartidor cercano...
                            </div>
                        )}
                        
                        {/* CASO: Finalizado */}
                        {isFinished && (
                            <div className="bg-black text-white py-4 rounded-xl text-center font-bold shadow-lg">
                                ‚úÖ Orden Completada
                            </div>
                        )}
                    </div>
                </div>

                {/* --- COLUMNA DERECHA: MAPA (65% ancho) --- */}
                <div className="flex-1 bg-gray-100 relative min-h-[400px] lg:min-h-screen">
                    <MapComponent mapId="active-map" />
                    
                    {/* Tarjeta Flotante de Precio (Estilo Main) */}
                    <div className="hidden lg:block absolute bottom-8 right-8 bg-white px-6 py-4 rounded-2xl shadow-2xl z-[400] border border-gray-100 transform hover:scale-105 transition-transform">
                        <p className="text-xs text-gray-400 font-bold uppercase mb-1 tracking-wider">Costo Total</p>
                        <p className="text-3xl font-black text-gray-900">${order.costoEnvio}</p>
                    </div>
                </div>

            </div>
        );
    }

    // --- NUEVO DASHBOARD DE REPARTIDOR ---
    // Dashboard de Repartidor con Modal de Confirmaci√≥n y Simulaci√≥n Push
// --- NUEVO DASHBOARD DE REPARTIDOR (CORREGIDO) ---
    function DriverDashboardView({ onGoBack, onNavigateToActiveOrder, currentUser, setIncomingOrder, onToggleOnline }) {
      // 1. "isOnline" ahora es simplemente un reflejo de la base de datos
      const isOnline = currentUser?.disponible;
      
      const [orders, setOrders] = useState([]);
      const [myStats, setMyStats] = useState({ ganancia: 0, completados: 0 });
      const [loading, setLoading] = useState(false);
      const [selectedOrder, setSelectedOrder] = useState(null);

      // 2. useEffect: Si el usuario se conecta, cargamos datos; si se desconecta, limpiamos la lista.
      useEffect(() => {
          if (!isOnline) return;
          
          const checkNewOrders = async () => {
              const nuevos = await apiCall("/pedido/publicados/");
              if (nuevos.length > orders.length && nuevos[0]) {
                  setIncomingOrder(nuevos[0]); // Auto-mostrar popup
              }
              setOrders(nuevos);
          };
          
          const interval = setInterval(checkNewOrders, 5000); // Cada 5 seg
          return () => clearInterval(interval);
      }, [isOnline, orders.length]);
      useEffect(() => {
          // Definimos la funci√≥n de carga AQU√ç dentro para que se ejecute siempre al entrar
          const fetchData = async () => {
              // Validaci√≥n de seguridad
              if (currentUser?.estado_verificacion !== 'Aprobado') {
                  setOrders([]);
                  setMyStats({ ganancia: "0.00", completados: 0 });
                  return;
              }
              
              setLoading(true);
              try {
                  // 1. Cargar pedidos disponibles (Muro)
                  const disponibles = await apiCall("/pedido/publicados/");
                  setOrders(disponibles);

                  // 2. Cargar mis ganancias (ESTAD√çSTICAS)
                  if (currentUser) {
                      try {
                          const stats = await apiCall("/pedido/ganancias/");
                          // Actualizamos el estado con los datos frescos del backend
                          setMyStats({
                              ganancia: stats.ganancias_acumuladas.toFixed(2),
                              completados: stats.pedidos_completados || 0 
                          });
                      } catch(e) {
                          console.warn("No se pudieron cargar ganancias:", e);
                          setMyStats({ ganancia: "0.00", completados: 0 });
                      }
                  }
              } catch (error) { 
                  console.error(error); 
              } finally { 
                  setLoading(false); 
              }
          };

          // Solo ejecutamos si el repartidor est√° "En L√≠nea"
          if (isOnline) {
              fetchData();
          } else {
              setOrders([]);
          }
          
          // ALERTA: La dependencia clave es [isOnline]. 
          // Al volver de la pantalla de "Pedido Entregado", este componente se monta de nuevo
          // y React ejecutar√° este efecto autom√°ticamente.
      }, [isOnline, currentUser]);

      const handleRequestAccept = (order) => { 
          setSelectedOrder(order); 
      };
      
      const confirmAccept = async (orderId) => {
          if (!isOnline) return alert("‚ö†Ô∏è Debes conectarte para trabajar.");
          
          try {
              await apiCall(`/pedido/aceptar/${orderId}/`, "PATCH");
              alert("¬°Pedido aceptado! Redirigiendo al mapa...");
              setSelectedOrder(null);
              onNavigateToActiveOrder(orderId);
          } catch (error) {
              alert("Error: " + error.message);
              fetchData();
          }
      };

      return (
        <div className="min-h-screen bg-gray-50 pb-20 animate-in fade-in">
          <header className="bg-white shadow-sm sticky top-0 z-30 border-b border-gray-100">
            <div className="max-w-3xl mx-auto px-4 py-4">
                <div className="flex items-center justify-between mb-4">
                    <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ArrowLeft /></button>  
                    <button 
                        onClick={onToggleOnline} 
                        className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold transition-all shadow-sm ${isOnline ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}
                    >
                        {isOnline ? "üü¢ EN L√çNEA" : "üî¥ DESCONECTADO"}
                    </button>
                </div>

                <div className="grid grid-cols-2 divide-x divide-gray-100 mt-2">
                    <div className="text-center px-4">
                        <p className="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Ganancia Hoy</p>
                        <p className="text-3xl font-black text-gray-900 tracking-tight">${myStats.ganancia}</p>
                    </div>
                    <div className="text-center px-4">
                        <p className="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Entregas</p>
                        <p className="text-3xl font-black text-gray-900 tracking-tight">{myStats.completados}</p>
                    </div>
                </div>
            </div>
          </header>

          <main className="max-w-3xl mx-auto px-4 py-6">
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold text-gray-800">
                    {isOnline ? `Pedidos Disponibles (${orders.length})` : "Estaci√≥n de trabajo"}
                </h2>
                
                {isOnline && orders.length > 0 && (
                    <button 
                        onClick={() => setIncomingOrder(orders[0])} 
                        className="text-xs bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold hover:bg-blue-200 transition-colors"
                    >
                        üîî Simular Push
                    </button>
                )}
            </div>

            <div className="relative min-h-[400px]">
                {!isOnline && (
                    <div className="absolute inset-0 z-10 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6 rounded-2xl border-2 border-dashed border-gray-200">
                        <div className="bg-gray-100 p-6 rounded-full mb-4"><span className="text-4xl">üò¥</span></div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Est√°s desconectado</h3>
                        <p className="text-gray-500 mb-8 max-w-xs mx-auto">Con√©ctate para ver los pedidos disponibles y ganar dinero.</p>
                        {/* AQU√ç USAMOS onToggleOnline DIRECTAMENTE */}
                        <button onClick={onToggleOnline} className="bg-black text-white px-10 py-4 rounded-full font-bold text-lg hover:bg-gray-800 transition-transform transform hover:scale-105 shadow-xl">CONECTARSE</button>
                    </div>
                )}

                <div className={`space-y-4 transition-all duration-500 ${!isOnline ? 'opacity-20 pointer-events-none' : 'opacity-100'}`}>
                    {orders.length === 0 ? (
                        <div className="text-center py-16 bg-white rounded-xl border border-gray-100 shadow-sm">
                            {currentUser?.estado_verificacion !== 'Aprobado' ? (
                                <>
                                    <div className="text-6xl mb-4">‚è≥</div>
                                    <p className="text-gray-800 font-bold mb-2">Cuenta en Revisi√≥n</p>
                                    <p className="text-gray-500 text-sm">Un administrador est√° verificando tu identidad.</p>
                                </>
                            ) : (
                                <p className="text-gray-400">No hay pedidos disponibles en este momento.</p>
                            )}
                        </div>
                    ) : (
                        orders.map(order => (
                            <div key={order.codigoPedido} className="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                                <div className="flex justify-between items-start mb-2">
                                    <span className="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-md font-bold uppercase">Nuevo</span>
                                    <span className="block text-2xl font-black text-gray-900">${order.costoEnvio}</span>
                                </div>
                                <h3 className="font-bold text-lg text-gray-800 mb-1">{order.descripcion}</h3>
                                <p className="text-xs text-gray-500 mb-4">üìç Recoger en: {order.punto_origen}</p>
                                <button onClick={() => handleRequestAccept(order)} className="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800">ACEPTAR PEDIDO</button>
                            </div>
                        ))
                    )}
                </div>
            </div>
          </main>
          
          {selectedOrder && (
              <DriverAcceptanceModal 
                  order={selectedOrder} 
                  onConfirm={confirmAccept} 
                  onCancel={() => setSelectedOrder(null)} 
              />
          )}
        </div>
      );
    }
        
// Vista de Perfil del Repartidor con Historial
    function DriverProfileView({ user, onGoBack }) {
        const [history, setHistory] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            if (user?.id) { fetchHistory(); }
        }, [user]);

        const fetchHistory = async () => {
            setLoading(true);
            try {
                const data = await apiCall("/pedido/listar/");
                const myDeliveries = data.filter(o => o.idRepartidor === user.id);
                setHistory(myDeliveries.reverse());
            } catch (error) { 
                console.error("Error fetching driver history:", error); 
            } finally { 
                setLoading(false); 
            }
        };

        const getCardColor = (status) => { 
            switch (status) { 
                case 'Entregado': return 'border-green-500'; 
                case 'Aceptado': return 'border-orange-500'; 
                default: return 'border-red-500'; 
            } 
        };
        
        const getBadgeColor = (status) => { 
            switch (status) { 
                case 'Entregado': return 'bg-green-500'; 
                case 'Aceptado': return 'bg-orange-500'; 
                default: return 'bg-red-500'; 
            } 
        };

        return (
            <div className="min-h-screen bg-white p-4 sm:p-8 animate-in fade-in duration-300">
                <header className="max-w-4xl mx-auto mb-8 flex items-center">
                    <button onClick={onGoBack} className="p-2 hover:bg-gray-100 rounded-full transition-colors mr-4">
                        <ArrowLeft />
                    </button>
                    <h2 className="text-3xl font-bold text-black">Perfil</h2>
                </header>
                <main className="max-w-4xl mx-auto">
                    <div className="flex items-center gap-6 mb-12">
                        <div className="w-24 h-24 rounded-full bg-[#EFE6FD] flex items-center justify-center text-[#5B21B6] overflow-hidden border-4 border-white shadow-md">
                            {user?.foto_perfil ? (
                                <img src={user.foto_perfil} className="w-full h-full object-cover" alt="Perfil" />
                            ) : (
                                <User className="w-12 h-12" />
                            )}
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold text-black mb-1">Hola, Repartidor.</h1>
                            <p className="text-gray-500 text-lg">{user?.nombre} {user?.apellido}</p>
                        </div>
                    </div>
                    <h3 className="text-2xl font-black text-black mb-6">Historial de entregas.</h3>
                    {loading ? (
                        <div className="text-center py-10 text-gray-500">Cargando historial...</div>
                    ) : history.length === 0 ? (
                        <div className="text-center py-10 text-gray-500 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            <p>A√∫n no has realizado entregas.</p>
                        </div>
                    ) : (
                        <div className="space-y-6 pb-20">
                            {history.map(order => (
                                <div key={order.codigoPedido} className={`bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden flex border-l-[8px] ${getCardColor(order.estado)}`}>
                                    <div className="p-5 w-full">
                                        <div className="flex justify-between items-start mb-2">
                                            <h4 className="font-bold text-black text-lg">C√≥digo de pedido: {order.codigoPedido}</h4>
                                            <span className={`px-3 py-1 rounded text-xs font-bold text-white uppercase tracking-wide ${getBadgeColor(order.estado)}`}>
                                                {order.estado}
                                            </span>
                                        </div>
                                        <p className="text-gray-800 text-sm mb-6 font-medium">{order.descripcion}</p>
                                        <div className="flex justify-between items-center pt-4 border-t border-gray-200">
                                            <div>
                                                <p className="text-xs font-bold text-black uppercase mb-1">Fecha</p>
                                                <p className="text-sm font-bold text-black">{new Date(order.fechaInicial).toLocaleDateString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs font-bold text-black uppercase mb-1">Valor</p>
                                                <p className="text-sm font-bold text-black">${order.costoEnvio}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </main>
            </div>
        );
    }


    function MyOrdersView({ onGoBack, onNavigateToActiveOrder, currentUserId }) {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => { fetchMyOrders(); }, []);
      const fetchMyOrders = async () => { try { const data = await apiCall("/pedido/listar/"); const misPedidos = data.filter(o => o.idCliente === currentUserId); setOrders(misPedidos.reverse()); } catch (error) { console.error(error); } finally { setLoading(false); } };
      const getStatusColor = (estado) => { switch(estado) { case "Publicado": return "bg-gray-100 text-gray-600"; case "Aceptado": return "bg-blue-100 text-blue-700"; case "Entregado": return "bg-green-100 text-green-700"; default: return "bg-gray-100"; } };
      return (
        <div className="min-h-screen bg-gray-50 p-4 animate-in fade-in">
          <header className="flex items-center mb-6"><button onClick={onGoBack} className="p-2 mr-4 bg-white rounded-full shadow"><ArrowLeft /></button><h1 className="text-2xl font-bold text-gray-800">Mis Pedidos</h1></header>
          {loading ? <p className="text-center py-10">Cargando historial...</p> : (
            <div className="space-y-4 max-w-2xl mx-auto">
                {orders.length === 0 && (<div className="text-center py-10 text-gray-500 bg-white rounded-xl shadow-sm"><p className="mb-2">No has realizado pedidos a√∫n.</p></div>)}
                {orders.map(order => (
                    <div key={order.codigoPedido} onClick={() => { if (order.estado === "Aceptado" || order.estado === "Entregado") { onNavigateToActiveOrder(order.codigoPedido); } }} className={`bg-white p-5 rounded-xl shadow-sm border border-gray-100 transition-all ${order.estado === "Aceptado" ? "cursor-pointer hover:shadow-md ring-1 ring-blue-200" : ""}`}>
                        <div className="flex justify-between items-start mb-2"><div><span className={`text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wider ${getStatusColor(order.estado)}`}>{order.estado}</span><span className="text-gray-400 text-xs ml-2">#{order.codigoPedido}</span></div><span className="font-bold text-gray-900">${order.costoEnvio}</span></div>
                        <h3 className="font-semibold text-gray-800 mb-1">{order.descripcion}</h3>
                        <div className="text-sm text-gray-500 mt-3 flex justify-between items-end"><span>üìÖ {new Date(order.fechaInicial).toLocaleDateString()}</span>{order.estado === "Aceptado" && (<span className="text-blue-600 font-medium text-xs flex items-center gap-1">Ver mapa <ChevronRight /></span>)}</div>
                    </div>
                ))}
            </div>
          )}
        </div>
      );
    }


    function HomePage() {
      const [menuOpen, setMenuOpen] = useState(false);
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [authMode, setAuthMode] = useState("signin");
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [currentUser, setCurrentUser] = useState(null);
      const [showUserMenu, setShowUserMenu] = useState(false); 
      // Estado para controlar el carrito/historial
      const [isCartOpen, setIsCartOpen] = useState(false);
      const [isProfileOpen, setIsProfileOpen] = useState(false);


      const [incomingOrder, setIncomingOrder] = useState(null);

      const [activeOrderId, setActiveOrderId] = useState(null);
      const [ignoredOrderId, setIgnoredOrderId] = useState(null);
      const [currentView, setCurrentView] = useState("home"); 
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [nombre, setNombre] = useState("");
      const [apellido, setApellido] = useState("");

      // --- funcion para el boton de enviar final y ESTADO PARA EL REGISTRO DE REPARTIDOR ---
      const [driverRegData, setDriverRegData] = useState({
          nombre: "", apellido: "", correo: "", contrasena: "",
          fotoPerfilFile: null, 
          fotoCarnetFile: null
      });


      const handleFinalDriverRegister = async () => {
          try {
              // ‚úÖ VALIDACI√ìN COMPLETA
              if (!driverRegData.nombre || !driverRegData.apellido) {
                  alert("‚ö†Ô∏è Completa tus datos personales primero.");
                  return;
              }
              if (!driverRegData.correo || !driverRegData.contrasena) {
                  alert("‚ö†Ô∏è Falta correo o contrase√±a.");
                  return;
              }
              if (!driverRegData.fotoPerfilFile) {
                  alert("‚ö†Ô∏è Falta foto de perfil.");
                  return;
              }
              if (!driverRegData.fotoCarnetFile) {
                  alert("‚ö†Ô∏è Falta foto del carnet estudiantil.");
                  return;
              }

              // Mostrar indicador de carga
              alert("üì§ Subiendo im√°genes a la nube...");

              // 1. Subir Foto Perfil a Cloudinary
              const urlPerfil = await uploadToCloudinary(driverRegData.fotoPerfilFile, 'perfil');
              
              // 2. Subir Foto Carnet a Cloudinary
              const urlCarnet = await uploadToCloudinary(driverRegData.fotoCarnetFile, 'carnet');

              // 3. Crear Usuario en Backend con las URLs reales
              const payload = {
                  nombre: driverRegData.nombre,
                  apellido: driverRegData.apellido,
                  correo: driverRegData.correo,
                  contrasena: driverRegData.contrasena,
                  rol: "repartidor",
                  foto_perfil: urlPerfil,
                  foto_carnet: urlCarnet,
              };

              await apiCall("/usuario/crear/", "POST", payload);
              
              alert("‚úÖ Registro completado! Tu cuenta ser√° revisada por un administrador. Te notificaremos por correo cuando sea aprobada.");
              
              // Limpiar y redirigir
              setDriverRegData({ 
                  nombre: "", apellido: "", correo: "", contrasena: "", 
                  fotoPerfilFile: null, fotoCarnetFile: null 
              });
              setCurrentView("home");

          } catch (error) {
              console.error("Error completo:", error);
              alert("‚ùå Error en el registro: " + error.message);
          }
      };

      //-------

      useEffect(() => {
        const checkStatus = async () => {
            if (!currentUser || !isLoggedIn) return;
            if (currentView === "activeOrder") return;
            try {
                const data = await apiCall("/pedido/listar/");
                const pedidoAceptado = data.find(p => 
                    p.estado === 'Aceptado' && 
                    currentUser && p.idCliente === currentUser.id
                );
                if (pedidoAceptado && pedidoAceptado.codigoPedido !== ignoredOrderId) { console.log("¬°Pedido detectado!", pedidoAceptado); setActiveOrderId(pedidoAceptado.codigoPedido); setCurrentView("activeOrder"); }
            } catch (error) { if (error.message !== "Sesi√≥n expirada") console.error(error); }
        };
        const interval = setInterval(checkStatus, 3000);
        return () => clearInterval(interval);
      }, [currentView, currentUser, isLoggedIn, ignoredOrderId]); 

      useEffect(() => { const token = localStorage.getItem("accessToken"); if (token) { apiCall("/usuario/me/").then(u => { setIsLoggedIn(true); setCurrentUser(u); }).catch(() => { setIsLoggedIn(false); localStorage.removeItem("accessToken"); }); } }, []);
      const handleLogout = () => { localStorage.removeItem("accessToken"); setIsLoggedIn(false); setCurrentUser(null); setShowUserMenu(false); };
      const reloadUser = async () => {
        const me = await apiCall("/usuario/me/");
        setCurrentUser(me);
      };

      const handleAcceptIncoming = async (orderId) => {
          setIncomingOrder(null); 
          try { 
              await apiCall(`/pedido/aceptar/${orderId}/`, "PATCH"); 
              alert("¬°Pedido aceptado! Redirigiendo al mapa..."); 
              setActiveOrderId(orderId);
              setCurrentView("activeOrder");
          } catch (error) { 
              alert("Error al aceptar: " + error.message); 
          }
      };

      const handleOpenProfile = () => {
          console.log("üü¢ handleOpenProfile llamado");
          console.log("üü¢ currentUser:", currentUser);
          console.log("üü¢ currentUser?.rol:", currentUser?.rol);
          if (currentUser?.rol === 'repartidor') { 
            console.log("üü¢ Es repartidor, cambiando vista");
            setCurrentView("driverProfile"); 
          } else { 
            console.log("üü¢ Es estudiante, abriendo modal");
            console.log("üü¢ Llamando setIsProfileOpen(true)");
            setIsProfileOpen(true); 
            console.log("üü¢ isProfileOpen deber√≠a ser true ahora");
          }
      };



      const handleAuth = async () => {
          console.log("Intentando autenticaci√≥n..."); 
          try {
              if (authMode === "signin") {
                  console.log("Enviando Login...", { email, pass });
                  const data = await apiCall("/login/", "POST", { email: email, password: pass });
                  localStorage.setItem("accessToken", data.access);
                  const me = await apiCall("/usuario/me/");
                  setCurrentUser(me); setIsLoggedIn(true); setShowAuthModal(false); alert(`¬°Hola de nuevo, ${me.nombre}!`);
              } else {
                  console.log("Enviando Registro...", { email, nombre, apellido, pass });
                  if (!nombre || !apellido || !email || !pass) { alert("Por favor completa todos los campos."); return; }
                  await apiCall("/usuario/crear/", "POST", { correo: email, contrasena: pass, nombre: nombre, apellido: apellido, rol: "estudiante" });
                  alert("‚úÖ ¬°Cuenta creada con √©xito! Ahora inicia sesi√≥n."); setAuthMode("signin"); 
              }
          } catch (e) { console.error("Error Auth:", e); alert("‚ùå Error: " + e.message); }
      };

      const faqData = [{ q: "¬øC√≥mo hago un pedido de un favor?", a: "Simplemente navega por las categor√≠as, selecciona el favor que necesitas, y completa los detalles de recogida y entrega." }, { q: "¬øC√≥mo s√© d√≥nde est√° mi pedido?", a: "Puedes seguir el progreso de tu favor en tiempo real desde la secci√≥n \"Historial de Pedidos\" y ver la ubicaci√≥n del repartidor en el mapa." }, { q: "¬øQu√© m√©todos de pago aceptan?", a: "Solo pago en efectivo." }, { q: "¬øPuedo cancelar un favor?", a: "S√≠, puedes cancelar un favor desde la secci√≥n \"Historial de Pedidos\" siempre y cuando el repartidor a√∫n no haya confirmado la recogida." }, { isSeparator: true }, { q: "¬øC√≥mo me registro para hacer entregas?", a: "Haz clic en \"Reg√≠strate para hacer entregas\" en la p√°gina principal, completa tus datos (carnet estudiantil) y sube tu foto de perfil." }, { q: "¬øQu√© necesito para ser repartidor?", a: "Solo necesitas tu carnet estudiantil vigente y tiempo libre para aceptar favores." }, { q: "¬øC√≥mo acepto un favor?", a: "Cuando haya un favor disponible cerca, aparecer√° una notificaci√≥n. Haz clic en \"Aceptar\" y se te mostrar√° el mapa con las direcciones de recogida y entrega." }, { q: "¬øCu√°ndo recibo mi pago?", a: "Recibes el pago del favor en efectivo directamente del cliente al momento de completar la entrega." }];

      const renderHelpView = () => {
        return (
          <div className="min-h-screen bg-gray-50">
            <header className="bg-white shadow-sm sticky top-0 z-50">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between h-16">
                  <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors"><Menu /></button>
                  <div className="flex items-center gap-3">
                    {isLoggedIn ? (
                      <div className="relative">
                        <button onClick={() => setShowUserMenu(!showUserMenu)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2">
                          <User />
                          <span className="text-sm font-medium hidden sm:block">{currentUser?.nombre || "Usuario"}</span>
                        </button>
                        {showUserMenu && (
                          <UserMenuDropdown 
                            user={currentUser} 
                            onClose={() => setShowUserMenu(false)} 
                            onLogout={handleLogout} 
                            onOpenProfile={handleOpenProfile}
                            onToggleOnline={handleToggleOnline} 
                          />
                        )}
                      </div>
                    ) : (
                      <><button onClick={() => { setAuthMode("signin"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Sign in</button><button onClick={() => { setAuthMode("register"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg transition-colors">Register</button></>
                    )}
                    <div className="w-px h-8 bg-gray-300 mx-2" />
                    
                    {/* --- BOT√ìN CARRITO: Abre el popup --- */}
                    <button onClick={() => setIsCartOpen(!isCartOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative">
                      <ShoppingCart />
                    </button>
                  
                  </div>
                </div>
              </div>
              
              {/* --- POPUP HISTORIAL --- */}
              <OrderHistoryPopup 
                  isOpen={isCartOpen} 
                  onClose={() => setIsCartOpen(false)}
                  currentUserId={currentUser?.id}
                  onNavigateToFullHistory={() => {
                      setIsCartOpen(false);
                      setCurrentView("myOrders");
                  }}
              />
              {(() => {
                  console.log("üü° Renderizando - isProfileOpen:", isProfileOpen);
                  console.log("üü° currentUser:", currentUser);
                  return null;
              })()}
              {/* --- MODAL EDICI√ìN DE PERFIL (Estudiante) --- */}
              {isProfileOpen && (
                  <ProfileEditModal 
                      user={currentUser} 
                      onClose={() => setIsProfileOpen(false)} 
                      onUpdateUser={reloadUser}
                  />
              )}

              {/* --- MODAL NOTIFICACI√ìN PUSH (Repartidor) --- */}
              <IncomingOrderModal 
                  order={incomingOrder}   
                  onAccept={handleAcceptIncoming} 
                  onReject={() => setIncomingOrder(null)} 
              />

              {showAuthModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-in zoom-in-95 duration-200">
                    <div className="flex items-center justify-between p-6 pb-4"><h2 className="text-xl font-semibold text-gray-800">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</h2><button onClick={() => setShowAuthModal(false)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X /></button></div>
                    <div className="px-6 pb-6">
                      <div className="space-y-4">
                          {authMode === "register" && (<><div><label className="block text-sm font-medium text-gray-700 mb-2">Nombre</label><input type="text" placeholder="Tu Nombre" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none" value={nombre} onChange={e => setNombre(e.target.value)} /></div><div><label className="block text-sm font-medium text-gray-700 mb-2">Apellido</label><input type="text" placeholder="Tu Apellido" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none" value={apellido} onChange={e => setApellido(e.target.value)} /></div></>)}
                        <div><label className="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" placeholder="nombre@ejemplo.com" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={email} onChange={e => setEmail(e.target.value)} /></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label><input type="password" placeholder="********" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={pass} onChange={e => setPass(e.target.value)} /></div>
                        <button onClick={handleAuth} className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors mt-6">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</button>
                        {authMode === "signin" && (<div className="text-center mt-4"><button className="text-sm text-gray-600 hover:text-black transition-colors underline">¬øContrase√±a olvidada?</button></div>)}
                        <div className="text-center mt-6 pt-6 border-t border-gray-200"><p className="text-sm text-gray-600">{authMode === "signin" ? "¬øNo tienes cuenta?" : "¬øYa tienes cuenta?"} <button onClick={() => setAuthMode(authMode === "signin" ? "register" : "signin")} className="text-black font-medium hover:underline">{authMode === "signin" ? "Reg√≠strate" : "Inicia sesi√≥n"}</button></p></div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              {menuOpen && (<div className="absolute top-16 left-0 w-64 bg-white shadow-lg border-t animate-in slide-in-from-left z-50"><nav className="py-2"><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("home"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Inicio</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("myOrders"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Mis pedidos</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("driverRegister"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ser repartidor</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("help"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ayuda</a></nav></div>)}
            </header>
            <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-8">
                {faqData.map((item, index) => {
                  if (item.isSeparator) { return (<div key={index} className="md:col-span-2 border-t border-gray-200 my-4"></div>); }
                  return (<React.Fragment key={index}><div className="flex flex-col justify-center"><h3 className="text-lg font-semibold text-gray-800 py-4 border-b border-gray-200">{item.q}</h3></div><div className="flex flex-col justify-center"><p className="text-gray-600 py-4 border-b border-gray-200">{item.a}</p></div></React.Fragment>);
                })}
              </div>
            </main>
          </div>
        );
      };
      const handleToggleOnline = async () => {
          if (!currentUser) return;
          
          // 1. Calculamos el nuevo estado (lo opuesto a lo que es ahora)
          const nuevoEstado = !currentUser.disponible;
          
          // 2. ACTUALIZACI√ìN OPTIMISTA (Actualizamos la UI inmediatamente)
          // Esto hace que el bot√≥n cambie de color al instante en el hijo
          setCurrentUser({ ...currentUser, disponible: nuevoEstado });

          try {
              // 3. ACTUALIZACI√ìN EN BASE DE DATOS (Backend)
              await apiCall(`/usuario/actualizar/${currentUser.id}/`, "PATCH", { 
                  disponible: nuevoEstado 
              });
              console.log("Estado sincronizado con DB:", nuevoEstado);
          } catch (error) {
              console.error("Error al guardar estado:", error);
              // Si falla, revertimos el cambio visual para que el usuario sepa
              setCurrentUser({ ...currentUser, disponible: !nuevoEstado });
              alert("Error de conexi√≥n. No se pudo cambiar el estado.");
          }
      };
      if (currentView === "newFavor") { return <NewFavorView onGoBack={() => setCurrentView("home")} onNavigateToSendReceive={() => setCurrentView("sendReceive")} onNavigateToFastPrints={() => setCurrentView("fastPrints")} onNavigateToBuyTake={() => setCurrentView("buyTake")} />; }
      if (currentView === "sendReceive") { return <SendReceiveView onGoBack={() => setCurrentView("newFavor")} onNavigateToFastPrints={() => setCurrentView("fastPrints")} onNavigateToBuyTake={() => setCurrentView("buyTake")} />; }
      if (currentView === "fastPrints") { return <FastPrintsView onGoBack={() => setCurrentView("newFavor")} onNavigateToSendReceive={() => setCurrentView("sendReceive")} onNavigateToBuyTake={() => setCurrentView("buyTake")} />; }
      if (currentView === "buyTake") { return <BuyTakeView onGoBack={() => setCurrentView("newFavor")} onNavigateToSendReceive={() => setCurrentView("sendReceive")} onNavigateToFastPrints={() => setCurrentView("fastPrints")} />; }
      if (currentView === "help") { return renderHelpView(); }
      if (currentView === "activeOrder") { return <ActiveOrderView orderId={activeOrderId} userRole={currentUser?.rol} onGoBack={() => { setIgnoredOrderId(activeOrderId); setCurrentView("home"); }} />; }
      if (currentView === "driverFeed") { 
          return <DriverDashboardView 
              onGoBack={() => setCurrentView("home")} 
              currentUser={currentUser}
              setIncomingOrder={setIncomingOrder}
              
              // ESTA L√çNEA ES EL PUENTE (Pasa la funci√≥n al hijo)
              onToggleOnline={handleToggleOnline} 
              
              onNavigateToActiveOrder={(id) => { setActiveOrderId(id); setCurrentView("activeOrder"); }} 
          />; 
      }
      if (currentView === "myOrders") { return <MyOrdersView onGoBack={() => setCurrentView("home")} currentUserId={currentUser?.id} onNavigateToActiveOrder={(id) => { setActiveOrderId(id); setCurrentView("activeOrder"); }} />; }
      // Actualizacion y aniadidos de renders del registro del repartidor
      if (currentView === "driverProfile") { 
        return <DriverProfileView 
          user={currentUser} 
          onGoBack={() => setCurrentView("home")} 
        />; 
      }
      if (currentView === "driverRegister") { return <DriverRegisterView onGoBack={() => setCurrentView("home")} onNavigateToWelcome={() => setCurrentView("driverWelcome")} onSignIn={() => { setAuthMode("signin"); setShowAuthModal(true); }} onRegister={() => { setCurrentView("driverWelcome"); /* Vamos directo al flujo nuevo */ }} />; }
      if (currentView === "driverWelcome") { 
          return <DriverWelcomeView 
              onGoBack={() => setCurrentView("driverRegister")} 
              regData={driverRegData}
              onNavigateToBasicData={() => setCurrentView("driverBasicData")}
              onNavigateToProfilePhoto={() => setCurrentView("profilePhotoUpload")} 
              onNavigateToCarnetPhoto={() => setCurrentView("carnetPhotoUpload")} 
              onFinalRegister={handleFinalDriverRegister}
          />; 
      }
      if (currentView === "driverBasicData") {
          return <DriverBasicDataView 
              data={driverRegData}
              onSave={(newData) => setDriverRegData(prev => ({ ...prev, ...newData }))}
              onGoBack={() => setCurrentView("driverWelcome")}
          />;
      }
      if (currentView === "profilePhotoUpload") { 
          return <ProfilePhotoUploadView 
            onGoBack={() => setCurrentView("driverWelcome")} 
            onSave={(file) => {
                setDriverRegData(prev => ({...prev, fotoPerfilFile: file}));
                setCurrentView("driverWelcome");
            }}
          />; 
      }
      if (currentView === "carnetPhotoUpload") { 
          return <CarnetPhotoUploadView 
            onGoBack={() => setCurrentView("driverWelcome")} 
            onSave={(file) => {
                setDriverRegData(prev => ({...prev, fotoCarnetFile: file}));
                setCurrentView("driverWelcome");
            }}
          />; 
      }
      // -----------
    // --- PEGAR ESTO DENTRO DE HomePage, ANTES DEL RETURN ---
// DENTRO DE function HomePage() { ...

// --- L√ìGICA EN HomePage (EL CEREBRO) ---

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white shadow-sm sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex items-center justify-between h-16">
                <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors"><Menu /></button>
                <div className="flex items-center gap-3">
                  {isLoggedIn ? (
                    <div className="relative">
                      <button onClick={() => setShowUserMenu(!showUserMenu)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2">
                        <User />
                        <span className="text-sm font-medium hidden sm:block">{currentUser?.nombre || "Usuario"}</span>
                      </button>
                      {showUserMenu && (
                        <UserMenuDropdown 
                          user={currentUser} 
                          onClose={() => setShowUserMenu(false)} 
                          onLogout={handleLogout} 
                          onOpenProfile={handleOpenProfile}
                          onToggleOnline={handleToggleOnline} 
                        />
                      )}
                    </div>
                  ) : (
                    <><button onClick={() => { setAuthMode("signin"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Sign in</button><button onClick={() => { setAuthMode("register"); setShowAuthModal(true); }} className="px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg transition-colors">Register</button></>
                  )}
                  <div className="w-px h-8 bg-gray-300 mx-2" />
                  
                  <button onClick={() => setIsCartOpen(!isCartOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors relative">
                    <ShoppingCart />
                  </button>
                
                </div>
              </div>
            </div>
            
            {/* --- POPUP HISTORIAL --- */}
            <OrderHistoryPopup 
                isOpen={isCartOpen} 
                onClose={() => setIsCartOpen(false)}
                currentUserId={currentUser?.id}
                onNavigateToFullHistory={() => {
                    setIsCartOpen(false);
                    setCurrentView("myOrders");
                }}
            />

            {/* --- MODAL EDICI√ìN DE PERFIL (Estudiante) --- */}
            {isProfileOpen && (
                <ProfileEditModal 
                    user={currentUser} 
                    onClose={() => setIsProfileOpen(false)} 
                    onUpdateUser={reloadUser}
                />
            )}

            {/* --- MODAL NOTIFICACI√ìN PUSH (Repartidor) --- */}
            <IncomingOrderModal 
                order={incomingOrder}   
                onAccept={handleAcceptIncoming} 
                onReject={() => setIncomingOrder(null)} 
            />

            {showAuthModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-in zoom-in-95 duration-200">
                  <div className="flex items-center justify-between p-6 pb-4"><h2 className="text-xl font-semibold text-gray-800">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</h2><button onClick={() => setShowAuthModal(false)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X /></button></div>
                  <div className="px-6 pb-6">
                    <div className="space-y-4">
                        {authMode === "register" && (<><div><label className="block text-sm font-medium text-gray-700 mb-2">Nombre</label><input type="text" placeholder="Tu Nombre" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none" value={nombre} onChange={e => setNombre(e.target.value)} /></div><div><label className="block text-sm font-medium text-gray-700 mb-2">Apellido</label><input type="text" placeholder="Tu Apellido" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none" value={apellido} onChange={e => setApellido(e.target.value)} /></div></>)}
                      <div><label className="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" placeholder="nombre@ejemplo.com" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={email} onChange={e => setEmail(e.target.value)} /></div>
                      <div><label className="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label><input type="password" placeholder="********" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black outline-none transition-all" value={pass} onChange={e => setPass(e.target.value)} /></div>
                      <button onClick={handleAuth} className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors mt-6">{authMode === "signin" ? "Iniciar sesi√≥n" : "Registrarse"}</button>
                      {authMode === "signin" && (<div className="text-center mt-4"><button className="text-sm text-gray-600 hover:text-black transition-colors underline">¬øContrase√±a olvidada?</button></div>)}
                      <div className="text-center mt-6 pt-6 border-t border-gray-200"><p className="text-sm text-gray-600">{authMode === "signin" ? "¬øNo tienes cuenta?" : "¬øYa tienes cuenta?"} <button onClick={() => setAuthMode(authMode === "signin" ? "register" : "signin")} className="text-black font-medium hover:underline">{authMode === "signin" ? "Reg√≠strate" : "Inicia sesi√≥n"}</button></p></div>
                    </div>
                  </div>
                </div>
              </div>
            )}
            {menuOpen && (<div className="absolute top-16 left-0 w-64 bg-white shadow-lg border-t animate-in slide-in-from-left z-50"><nav className="py-2"><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("home"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Inicio</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("myOrders"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Mis pedidos</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("driverRegister"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ser repartidor</a><a href="#" onClick={(e) => { e.preventDefault(); setCurrentView("help"); setMenuOpen(false); }} className="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">Ayuda</a></nav></div>)}
          </header>
          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {/* HERO BANNER (Sin cambios) */}
            <div className="relative rounded-2xl overflow-hidden mb-12 h-64 sm:h-80 animate-in fade-in slide-in-from-bottom-4 duration-700" style={{ animationDelay: "100ms" }}>
              <div className="absolute inset-0 bg-gradient-to-br from-amber-400 via-orange-300 to-amber-200">
                <div className="absolute inset-0 opacity-20">
                  <div className="absolute top-10 right-20 w-32 h-32 bg-white rounded-full blur-3xl"></div>
                  <div className="absolute bottom-20 left-10 w-40 h-40 bg-orange-500 rounded-full blur-3xl"></div>
                </div>
                <div className="absolute bottom-0 left-0 w-full h-full flex items-end justify-start pl-12">
                   <div className="relative w-48 h-64">
                     <div className="absolute top-8 left-12 w-16 h-16 bg-amber-900 rounded-full"></div>
                     <div className="absolute top-20 left-14 w-12 h-8 bg-amber-950 rounded-b-full"></div>
                     <div className="absolute top-24 left-4 w-32 h-40 bg-gradient-to-b from-yellow-500 to-yellow-600 rounded-t-3xl"></div>
                     <div className="absolute top-20 left-8 w-24 h-20 bg-yellow-600 rounded-t-full"></div>
                   </div>
                </div>
              </div>
              <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-transparent" />
              <div className="relative h-full flex flex-col justify-center px-8 sm:px-12">
                <h1 className="text-4xl sm:text-5xl font-bold text-white mb-3 animate-in slide-in-from-left duration-700" style={{ animationDelay: "150ms" }}>Pide tu favor ahora.</h1>
                <p className="text-lg sm:text-xl text-white/90 animate-in slide-in-from-left duration-700" style={{ animationDelay: "300ms" }}>Solo pago en efectivo</p>
              </div>
            </div>
            
            {/* GRID DE OPCIONES */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              
{/* TARJETA 1: PEDIR FAVOR (DISE√ëO RESTAURADO) */}
              <div className="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden animate-in fade-in slide-in-from-bottom-4" style={{ animationDelay: "150ms" }}>
                <div className="h-48 relative overflow-hidden bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
                    <div className="absolute inset-0 flex items-center justify-center">
                        {/* Mano Izquierda (Amarilla) */}
                        <div className="relative mr-8">
                            <div className="w-16 h-20 bg-amber-200 rounded-t-full rounded-b-lg transform -rotate-12"></div>
                            <div className="absolute -top-3 left-2 w-3 h-8 bg-amber-200 rounded-full transform -rotate-12"></div>
                            <div className="absolute -top-4 left-5 w-3 h-10 bg-amber-200 rounded-full transform rotate-3"></div>
                            <div className="absolute -top-3 left-8 w-3 h-9 bg-amber-200 rounded-full transform rotate-12"></div>
                            <div className="absolute -top-2 left-11 w-3 h-7 bg-amber-200 rounded-full transform rotate-20"></div>
                            <div className="absolute -bottom-6 left-4 w-8 h-8 bg-amber-300 rounded"></div>
                        </div>
                        {/* Mano Derecha (Rosa) */}
                        <div className="relative ml-8">
                            <div className="w-16 h-20 bg-rose-200 rounded-t-full rounded-b-lg transform rotate-12"></div>
                            <div className="absolute -top-3 right-2 w-3 h-8 bg-rose-200 rounded-full transform rotate-12"></div>
                            <div className="absolute -top-4 right-5 w-3 h-10 bg-rose-200 rounded-full transform -rotate-3"></div>
                            <div className="absolute -top-3 right-8 w-3 h-9 bg-rose-200 rounded-full transform -rotate-12"></div>
                            <div className="absolute -top-2 right-11 w-3 h-7 bg-rose-200 rounded-full transform -rotate-20"></div>
                            <div className="absolute -bottom-6 right-4 w-8 h-8 bg-rose-300 rounded"></div>
                        </div>
                        {/* Icono Central */}
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                            <Hand className="w-8 h-8 text-purple-400 opacity-50 animate-pulse" />
                        </div>
                    </div>
                    {/* Decoraciones (Bolitas) */}
                    <div className="absolute top-8 left-8 w-2 h-2 bg-yellow-400 rounded-full animate-bounce"></div>
                    <div className="absolute top-12 right-12 w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{ animationDelay: "75ms" }}></div>
                    <div className="absolute bottom-12 left-16 w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{ animationDelay: "150ms" }}></div>
                </div>
                <div className="p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-2">Pide favores para mejorar tu comodidad.</h3>
                    <button onClick={() => setCurrentView("newFavor")} className="mt-4 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">Pedir favor</button>
                </div>
              </div>

              {/* TARJETA 2: L√ìGICA INTELIGENTE (Cambia seg√∫n rol) */}
              {isLoggedIn && currentUser?.rol === "repartidor" ? (
                  // --- OPCI√ìN A: SI ES REPARTIDOR (Muestra el Panel Negro AQU√ç) ---
                  <div className="bg-black rounded-xl shadow-xl overflow-hidden animate-in fade-in slide-in-from-bottom-4 text-white relative group" style={{ animationDelay: "300ms" }}>
                    <div className="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-40 transition-opacity">
                        <DeliveryIcon className="w-32 h-32 text-white transform rotate-12" />
                    </div>
                    <div className="h-full flex flex-col justify-center p-8 relative z-10">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-white/20 rounded-full backdrop-blur-sm">
                                <DeliveryIcon className="w-6 h-6 text-white" />
                            </div>
                            <span className="font-bold tracking-wider uppercase text-xs text-gray-300">Modo Trabajo</span>
                        </div>
                        <h3 className="text-2xl font-bold mb-2">Hola, {currentUser.nombre}.</h3>
                        <p className="text-gray-400 mb-6 text-sm">Hay pedidos esperando ser entregados. Con√©ctate y gana dinero.</p>
                        <button 
                            onClick={() => setCurrentView("driverFeed")} 
                            className="w-full sm:w-auto px-6 py-3 bg-white text-black rounded-lg font-bold hover:bg-gray-200 transition-colors shadow-lg flex items-center justify-center gap-2"
                        >
                            Ver Pedidos Disponibles <ChevronRight className="w-4 h-4" />
                        </button>
                    </div>
                  </div>
              ) : (
                  // --- OPCI√ìN B: SI NO ES REPARTIDOR (Muestra "√önete") ---
                  <div className="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden animate-in fade-in slide-in-from-bottom-4" style={{ animationDelay: "300ms" }}> 
                    <div className="h-48 bg-gradient-to-br from-orange-50 to-orange-100 flex items-center justify-center">
                        <UserPlus className="w-32 h-32 text-orange-500" />
                    </div>
                    <div className="p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">√önete como repartidor</h3>
                        <p className="text-sm text-gray-600 mb-4">Genera ingresos en tu tiempo libre. S√© tu propio jefe y con√©ctate para repartir cuando quieras.</p>
                        <button onClick={() => setCurrentView("driverRegister")} className="mt-2 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">Quiero trabajar</button>
                    </div>
                  </div>
              )}
            </div>

            {/* NOTA: HE BORRADO EL DIV NEGRO QUE ESTABA AQU√ç ABAJO PORQUE YA LO SUBIMOS AL GRID */}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<HomePage />);
    
  </script>
</body>
</html>